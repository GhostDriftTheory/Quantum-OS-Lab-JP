<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Quantum Key Factory: é‡å­éµè·äººã«ãªã‚ã†</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  
  <!-- OG / Twitter ã‚«ãƒ¼ãƒ‰è¨­å®š -->
  <meta property="og:type" content="website" />
  <meta property="og:title" content="Quantum Key Factory: é‡å­OSã§å®‰å…¨ãªéµã‚’ä½œã‚Œ" />
  <meta property="og:description" content="é‡å­ã®ã€Œå¹²æ¸‰ã€ã‚„ã€Œã‚‚ã¤ã‚Œã€ã‚’é§†ä½¿ã—ã¦ã€OSã®ç›£æŸ»ã‚’ã‚¯ãƒªã‚¢ã—ã€æœ€å¼·ã®æš—å·éµã‚’ç”Ÿç”£ã™ã‚‹ãƒ•ã‚¡ã‚¯ãƒˆãƒªãƒ¼ãƒ»ãƒ‡ãƒ¢ã€‚" />
  <meta property="og:image" content="https://ghostdrifttheory.github.io/Quantum-Core-Quantum-OS-Lab/quantum-factory-og.png" />
  <meta name="twitter:card" content="summary_large_image" />

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React & ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <!-- Babel -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- Phosphor Icons -->
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@400;700&family=Zen+Kaku+Gothic+New:wght@500;700&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: 'Zen Kaku Gothic New', sans-serif;
      background-color: #0f172a;
      color: #e2e8f0;
      overflow-x: hidden;
    }
    .font-tech {
      font-family: 'Chakra Petch', sans-serif;
    }
    
    /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    @keyframes pulse-glow {
      0%, 100% { opacity: 0.6; box-shadow: 0 0 10px currentColor; }
      50% { opacity: 1; box-shadow: 0 0 20px currentColor; }
    }
    .animate-pulse-glow {
      animation: pulse-glow 2s infinite;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-5px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-fadeIn {
      animation: fadeIn 0.5s ease-out forwards;
    }

    @keyframes bounce-right {
      0%, 100% { transform: translateX(0); }
      50% { transform: translateX(5px); }
    }
    .animate-bounce-right {
      animation: bounce-right 1s infinite;
    }

    /* ã‚°ãƒ©ã‚¹ãƒ¢ãƒ¼ãƒ•ã‚£ã‚ºãƒ ãƒ‘ãƒãƒ« */
    .glass-panel {
      background: rgba(15, 23, 42, 0.6);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(148, 163, 184, 0.1);
      box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
    }

    .btn-action {
      transition: all 0.2s;
    }
    .btn-action:active {
      transform: scale(0.95);
    }
    
    /* é‡å­ãƒ“ãƒƒãƒˆçƒä½“ */
    .qubit-sphere {
      width: 100px; height: 100px;
      border-radius: 50%;
      position: relative;
      background: radial-gradient(circle at 30% 30%, rgba(56, 189, 248, 0.2), rgba(2, 6, 23, 1));
      box-shadow: 0 0 20px rgba(56, 189, 248, 0.1), inset 0 0 10px rgba(56, 189, 248, 0.1);
      border: 1px solid rgba(56, 189, 248, 0.3);
      overflow: hidden;
      transition: all 0.5s ease;
    }
    @media (min-width: 768px) {
      .qubit-sphere { width: 140px; height: 140px; }
    }
    .qubit-sphere::before { content: ""; position: absolute; top: 50%; left: 0; right: 0; height: 1px; background: rgba(148, 163, 184, 0.3); }
    .qubit-sphere::after { content: ""; position: absolute; left: 50%; top: 0; bottom: 0; width: 1px; background: rgba(148, 163, 184, 0.3); }

    .qubit-soul {
      width: 14px; height: 14px;
      border-radius: 50%;
      background: radial-gradient(circle, #ffffff, #22d3ee);
      box-shadow: 0 0 10px #22d3ee, 0 0 20px #22d3ee;
      position: absolute;
      transform: translate(-50%, -50%);
      transition: top 0.4s cubic-bezier(0.34, 1.56, 0.64, 1), left 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      z-index: 10;
    }
    
    /* ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ */
    .progress-bar-bg { background: rgba(30, 41, 59, 0.8); border-radius: 9999px; overflow: hidden; }
    .progress-bar-fill { height: 100%; background: linear-gradient(90deg, #06b6d4, #3b82f6); transition: width 0.3s ease; }
    
    .custom-scrollbar::-webkit-scrollbar {
      width: 6px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
      background: rgba(15, 23, 42, 0.5);
      border-radius: 4px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
      background: rgba(56, 189, 248, 0.3);
      border-radius: 4px;
    }
  </style>
</head>
<body class="antialiased">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useMemo, useEffect, useRef } = React;

    // --- è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ ---
    function clamp01(x) { if (x < 0) return 0; if (x > 1) return 1; return x; }
    function normalize1q(s) { const n = Math.sqrt(s.a*s.a + s.b*s.b)||1; return { a:s.a/n, b:s.b/n }; }
    function normalize2q(s) { const n = Math.sqrt(s.a00*s.a00+s.a01*s.a01+s.a10*s.a10+s.a11*s.a11)||1; return {a00:s.a00/n,a01:s.a01/n,a10:s.a10/n,a11:s.a11/n}; }
    function gateH1q(s) { const r=1/Math.sqrt(2); return normalize1q({ a:r*(s.a+s.b), b:r*(s.a-s.b) }); }
    function gateH2q_Q1(s) { const r=1/Math.sqrt(2); return normalize2q({a00:r*(s.a00+s.a10), a01:r*(s.a01+s.a11), a10:r*(s.a00-s.a10), a11:r*(s.a01-s.a11)});}
    function gateCNOT_Q1toQ2(s) { return normalize2q({a00:s.a00, a01:s.a01, a10:s.a11, a11:s.a10}); }
    function noise1q(s) { return normalize1q({ a:s.a+(Math.random()-0.5)*0.4, b:s.b+(Math.random()-0.5)*0.4 }); }
    function noise2q(s) { const r=()=>(Math.random()-0.5)*0.3; return normalize2q({a00:s.a00+r(), a01:s.a01+r(), a10:s.a10+r(), a11:s.a11+r()}); }
    
    function measure1q(state) {
      const p0 = clamp01(state.a * state.a);
      const r = Math.random() < p0 ? 0 : 1;
      return { next: r===0 ? {a:1, b:0} : {a:0, b:1}, outcome: r };
    }
    function measure2q(state, idx) {
      const {a00,a01,a10,a11} = state;
      const p0 = idx===1 ? (a00*a00 + a01*a01) : (a00*a00 + a10*a10);
      const r = Math.random() < (p0||0) ? 0 : 1;
      if(idx===1) return r===0 ? {next:normalize2q({a00,a01,a10:0,a11:0}), outcome:0} : {next:normalize2q({a00:0,a01:0,a10,a11}), outcome:1};
      return r===0 ? {next:normalize2q({a00,a01:0,a10,a11:0}), outcome:0} : {next:normalize2q({a00:0,a01,a10:0,a11}), outcome:1};
    }

    function computeMetrics(mode, s, g, n) {
      if (mode === "1q") {
        const p0 = clamp01(s.a*s.a), p1 = clamp01(s.b*s.b);
        const stability = Math.abs(p0 - p1);
        const risk = clamp01(n / 8);
        return { p0, p1, stability, risk, safetyC: Math.round(stability*100), safetyQ: Math.round((1-risk)*100) };
      } else {
        const p0_1 = clamp01(s.a00*s.a00 + s.a01*s.a01), p1_1 = 1-p0_1;
        const p0_2 = clamp01(s.a00*s.a00 + s.a10*s.a10), p1_2 = 1-p0_2;
        const stability = Math.max(Math.abs(p0_1-p1_1), Math.abs(p0_2-p1_2));
        const ent = clamp01(4 * Math.abs(s.a00*s.a11 - s.a01*s.a10));
        const risk = clamp01((ent + n/8)/1.5);
        return { p0: p0_1, p1: p1_1, p0_2, p1_2, stability, risk, ent, safetyC: Math.round(stability*100), safetyQ: Math.round((1-risk)*100) };
      }
    }

    function checkBlock(mode, metrics, g, n) {
      if (mode === "1q") {
        if (metrics.stability < 0.2 && g >= 8) return true;
        if (metrics.risk > 0.7 && (g >= 6 || n >= 5)) return true;
      } else {
        if (metrics.risk > 0.6 && (g >= 6 || n >= 4)) return true;
        if (metrics.stability < 0.2 && metrics.ent > 0.5 && g >= 4) return true;
      }
      return false;
    }

    // --- UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ ---

    // 1. é‡å­ãƒ“ãƒƒãƒˆçƒä½“
    function QubitSphere({ p0, p1, label }) {
      const z = clamp01(p0) - clamp01(p1);
      const midX = 50; 
      const midY = 50 - (z * 40);

      return (
        <div className="flex flex-col items-center group">
          <div className="relative mb-2">
            <div className="qubit-sphere">
              <div className="qubit-soul" style={{ left: `${midX}%`, top: `${midY}%` }} />
              <div className="absolute top-2 left-0 right-0 text-center text-[9px] text-slate-500 font-mono">0 (è¡¨)</div>
              <div className="absolute bottom-2 left-0 right-0 text-center text-[9px] text-slate-500 font-mono">1 (è£)</div>
            </div>
          </div>
          {label && <div className="font-sci-fi text-cyan-400 tracking-wider text-[10px]">{label}</div>}
        </div>
      );
    }

    // 2. ç¢ºç‡ãƒãƒ¼
    function ProbBar({ p0, p1, label }) {
      const pct0 = Math.round(clamp01(p0) * 100);
      const pct1 = Math.round(clamp01(p1) * 100);

      return (
        <div className="w-full bg-slate-900/50 p-2 rounded-lg border border-slate-700/50">
          <div className="flex justify-between items-end mb-1">
            <span className="text-[10px] text-slate-400 font-mono">{label || "PROBABILITY"}</span>
            <span className="text-[10px] text-cyan-200">
              {pct0 === 50 && pct1 === 50 ? "ã©ã£ã¡ã‚‚50%" : pct0 > pct1 ? "0 ãŒå‡ºã‚„ã™ã„" : "1 ãŒå‡ºã‚„ã™ã„"}
            </span>
          </div>
          <div className="relative h-4 w-full flex rounded-sm overflow-hidden bg-slate-800">
            <div style={{ width: `${pct0}%` }} className="h-full bg-gradient-to-r from-blue-600 to-cyan-500 relative transition-all duration-300">
              {pct0 > 20 && <span className="absolute left-1 top-1/2 -translate-y-1/2 text-[9px] font-bold text-slate-900">0: {pct0}%</span>}
            </div>
            <div style={{ width: `${pct1}%` }} className="h-full bg-gradient-to-r from-purple-600 to-pink-500 relative transition-all duration-300">
              {pct1 > 20 && <span className="absolute right-1 top-1/2 -translate-y-1/2 text-[9px] font-bold text-white">1: {pct1}%</span>}
            </div>
          </div>
        </div>
      );
    }

    // 3. AI ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ
    function AssistantMessage({ lastDecision }) {
      if (!lastDecision) return <div className="h-12"></div>;
      
      let message = "æ“ä½œã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸã€‚";
      let mood = "neutral";

      if (lastDecision.decision === "ãƒ–ãƒ­ãƒƒã‚¯") {
        message = "âš ï¸ å±ãªã„ã®ã§ã€OSãŒæ“ä½œã‚’æ­¢ã‚ã¾ã—ãŸã€‚";
        mood = "danger";
      } else if (lastDecision.op.includes("è¦³æ¸¬")) {
        message = "è¦³æ¸¬ã—ã¾ã—ãŸã€‚çµæœãŒå‡ºã¾ã—ãŸã€‚";
        mood = "neutral";
      } else if (lastDecision.op.includes("ãƒ©ãƒ³ãƒ€ãƒ æ¶ˆå»") || lastDecision.op.includes("åŒå­")) {
        message = "é‡å­çŠ¶æ…‹ã‚’æ“ä½œã—ã¾ã—ãŸã€‚";
        mood = "happy";
      }

      const colorClass = mood === "danger" ? "text-rose-300 border-rose-500/50 bg-rose-950/30" : 
                         mood === "happy" ? "text-cyan-200 border-cyan-500/50 bg-cyan-950/30" : 
                         "text-slate-300 border-slate-600 bg-slate-900/50";

      return (
        <div className={`mt-3 p-3 rounded-xl border ${colorClass} transition-all duration-500 animate-fadeIn`}>
          <div className="flex items-center gap-3">
            <div className="text-xl">
              {mood === "danger" ? <i className="ph-fill ph-warning-octagon text-rose-500"></i> : 
               mood === "happy" ? <i className="ph-fill ph-sparkle text-cyan-400"></i> : 
               <i className="ph-fill ph-robot text-slate-400"></i>}
            </div>
            <p className="text-xs leading-snug font-medium">{message}</p>
          </div>
        </div>
      );
    }

    // 4. ãƒŸãƒƒã‚·ãƒ§ãƒ³ãƒ˜ãƒƒãƒ€ãƒ¼
    function MissionHeader({ keyLength, currentLength }) {
      return (
        <div className="mb-4 bg-slate-900 border border-emerald-500/50 rounded-xl p-4 shadow-lg shadow-emerald-500/10">
          <div className="flex items-start justify-between">
            <div>
              <h2 className="text-sm font-bold text-emerald-300 mb-1 flex items-center gap-2">
                <i className="ph-fill ph-target"></i> ä»Šæ—¥ã®ãƒŸãƒƒã‚·ãƒ§ãƒ³
              </h2>
              <p className="text-xs text-slate-300">
                OSã«ã€ŒOKã€ã¨è¨€ã‚ã›ã‚‹<span className="font-bold text-white">å®‰å…¨ãªéµ</span>ã‚’å®Œæˆã•ã›ã‚
              </p>
            </div>
            <div className="text-right">
              <div className="text-[10px] text-slate-400 font-mono mb-1">PROGRESS</div>
              <div className="text-xl font-tech text-white font-bold">{currentLength} / {keyLength}</div>
            </div>
          </div>
          <div className="mt-3 h-2 w-full progress-bar-bg">
            <div className="progress-bar-fill" style={{ width: `${(currentLength / keyLength) * 100}%` }}></div>
          </div>
        </div>
      );
    }

    // 5. éµãƒ¢ãƒ‹ã‚¿ãƒ¼
    function KeyMonitor({ bits, length }) {
      const slots = Array(length).fill("_").map((_, i) => bits[i] !== undefined ? bits[i] : "_");
      return (
        <div className="mb-4">
          <div className="flex justify-between items-end mb-1 px-1">
            <span className="text-[10px] text-slate-400">GENERATING KEY...</span>
          </div>
          <div className="bg-slate-950 border border-slate-700 rounded-lg p-3 overflow-x-auto whitespace-nowrap font-mono text-lg tracking-widest text-center shadow-inner">
            {slots.map((char, i) => (
              <span key={i} className={`inline-block w-6 text-center ${char === "_" ? "text-slate-700" : "text-cyan-300 animate-slide-in"}`}>
                {char}
              </span>
            ))}
          </div>
        </div>
      );
    }

    // 6. ã‚³ã‚¤ãƒ³æ“ä½œç›¤
    function ControlPanel({ mode, setMode, metrics, onScenario, onNoise, onMeasure, osMode, setOsMode, lastDecision, reset, tutorialStep }) {
      return (
        <div className="bg-slate-800/50 border border-slate-700 rounded-xl p-4 mb-4 relative overflow-hidden">
          
          {/* OSãƒãƒƒã‚¸ */}
          <div className="absolute top-3 right-3 flex flex-col items-end z-10">
             <div className="flex items-center gap-2 bg-slate-900/80 rounded-full px-2 py-1 border border-slate-600">
               <span className={`w-2 h-2 rounded-full ${osMode ? "bg-emerald-500 animate-pulse" : "bg-rose-500"}`}></span>
               <span className="text-[10px] font-bold text-slate-300">OS {osMode ? "ON" : "OFF"}</span>
             </div>
             {osMode && (
               <div className="mt-1 text-[9px] text-right">
                 <span className={metrics.safetyC > 60 ? "text-emerald-400" : "text-amber-400"}>å®‰å…¨åº¦: {metrics.safetyC}%</span>
               </div>
             )}
          </div>

          {/* ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«è¡¨ç¤ºã‚¨ãƒªã‚¢ */}
          <div className="flex items-center gap-4 mb-6 justify-center min-h-[120px]">
            {/* 0ã®ç¢ºç‡ */}
            <div className="w-16 flex flex-col justify-center gap-1 text-right">
               <div className="text-[9px] text-slate-400">0: {Math.round(metrics.p0*100)}%</div>
               <div className="h-1.5 w-full bg-slate-900 rounded-full overflow-hidden"><div className="h-full bg-cyan-500" style={{ width: `${metrics.p0*100}%` }}></div></div>
            </div>
            
            {/* ã‚³ã‚¤ãƒ³æœ¬ä½“ */}
            <div className="flex justify-center items-center">
               {mode === "1q" ? (
                 <QubitSphere p0={metrics.p0} p1={metrics.p1} />
               ) : (
                 <div className="flex gap-2">
                   <div className="scale-75"><QubitSphere p0={metrics.p0} p1={metrics.p1} /></div>
                   <div className="scale-75"><QubitSphere p0={metrics.p0_2} p1={metrics.p1_2} /></div>
                 </div>
               )}
            </div>

            {/* 1ã®ç¢ºç‡ */}
            <div className="w-16 flex flex-col justify-center gap-1 text-left">
               <div className="text-[9px] text-slate-400">1: {Math.round(metrics.p1*100)}%</div>
               <div className="h-1.5 w-full bg-slate-900 rounded-full overflow-hidden"><div className="h-full bg-purple-500" style={{ width: `${metrics.p1*100}%` }}></div></div>
            </div>
          </div>

          {/* AIãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */}
          <AssistantMessage lastDecision={lastDecision} />

          {/* æ“ä½œãƒœã‚¿ãƒ³ç¾¤ */}
          <div className="space-y-4 mt-4">
            
            {/* STEP 1: ç¢ºç‡æ“ä½œ */}
            <div className={`bg-slate-900/30 p-2 rounded-lg border transition-all duration-300 ${tutorialStep === 1 ? 'border-cyan-400 ring-2 ring-cyan-500/30' : 'border-slate-700/50'}`}>
                <div className="text-[10px] text-slate-400 font-bold mb-2 flex items-center gap-2">
                    <span className={`rounded-full w-4 h-4 flex items-center justify-center text-[9px] transition-colors ${tutorialStep === 1 ? 'bg-cyan-500 text-black' : 'bg-slate-600 text-white'}`}>1</span>
                    <span className={tutorialStep === 1 ? 'text-cyan-300' : ''}>ç¢ºç‡ã‚’ã„ã˜ã‚‹</span>
                    {tutorialStep === 1 && <span className="text-[9px] text-cyan-400 animate-pulse ml-auto">ğŸ‘ˆ ä»Šã“ã“ï¼</span>}
                </div>
                <div className="grid grid-cols-2 gap-2">
                    {/* ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ */}
                    <div className="col-span-2 flex gap-2 justify-center mb-1">
                        <button onClick={() => { setMode("1q"); reset(1); }} className={`px-3 py-1 rounded-full text-[10px] border ${mode==="1q"?"bg-slate-700 border-cyan-500 text-white":"border-slate-700 text-slate-500"}`}>ã‚³ã‚¤ãƒ³1æš</button>
                        <button onClick={() => { setMode("2q"); reset(2); }} className={`px-3 py-1 rounded-full text-[10px] border ${mode==="2q"?"bg-slate-700 border-purple-500 text-white":"border-slate-700 text-slate-500"}`}>ã‚³ã‚¤ãƒ³2æš</button>
                    </div>

                    {mode === "1q" ? (
                        <button onClick={() => onScenario("superposition")} className="btn-action bg-slate-700/50 border border-slate-600 p-2 rounded text-left hover:bg-slate-700">
                        <div className="text-[10px] text-cyan-300 font-bold">ğŸ® ãƒ©ãƒ³ãƒ€ãƒ æ¶ˆå»</div>
                        <div className="text-[9px] text-slate-400">ç¢ºç‡ã‚’åã‚‰ã›ã‚‹</div>
                        </button>
                    ) : (
                        <button onClick={() => onScenario("entangle")} className="btn-action bg-slate-700/50 border border-slate-600 p-2 rounded text-left hover:bg-slate-700 col-span-2">
                        <div className="text-[10px] text-pink-300 font-bold">ğŸ® åŒå­ã‚³ã‚¤ãƒ³</div>
                        <div className="text-[9px] text-slate-400">2æšã‚’é‹å‘½å…±åŒä½“ã«ã™ã‚‹</div>
                        </button>
                    )}
                    
                    {mode === "1q" && (
                        <button onClick={onNoise} className="btn-action bg-slate-700/50 border border-slate-600 p-2 rounded text-left hover:bg-slate-700">
                        <div className="text-[10px] text-slate-300 font-bold">ğŸŒª ãƒã‚¤ã‚ºã®åµ</div>
                        <div className="text-[9px] text-slate-400">é‚ªé­”ã‚’å…¥ã‚Œã‚‹</div>
                        </button>
                    )}
                </div>
            </div>

            {/* STEP 2: è¦³æ¸¬ */}
            <div className={`relative p-1 rounded-xl transition-all duration-300 ${tutorialStep === 2 ? 'bg-emerald-500/20 ring-2 ring-emerald-500/50' : ''}`}>
                <div className="absolute -top-2 left-2 bg-slate-800 text-[9px] text-emerald-200 px-2 rounded-full border border-emerald-500/50 z-10 flex items-center gap-1">
                    <span className={`rounded-full w-3 h-3 flex items-center justify-center text-[8px] ${tutorialStep === 2 ? 'bg-emerald-400 text-black' : 'bg-emerald-600 text-white'}`}>2</span>
                    ã“ã‚Œã§ç¢ºå®š
                </div>
                <button onClick={onMeasure} className="btn-action w-full py-3 bg-emerald-600 hover:bg-emerald-500 text-white rounded-xl text-sm font-bold shadow-lg shadow-emerald-900/50 flex flex-col items-center justify-center border-b-4 border-emerald-800 mt-2">
                <div className="flex items-center gap-2">
                    <i className="ph-bold ph-aperture text-xl"></i>
                    <span>è¦³æ¸¬ã—ã¦ 1 ãƒ“ãƒƒãƒˆè¿½åŠ </span>
                </div>
                </button>
            </div>

          </div>
          
          <div className="mt-2 text-center">
             <button onClick={() => setOsMode(!osMode)} className="text-[9px] text-slate-600 underline">å®‰å…¨è£…ç½®(OS)ã®è¨­å®šå¤‰æ›´</button>
          </div>
        </div>
      );
    }

    // 7. ãƒªã‚¶ãƒ«ãƒˆã‚«ãƒ¼ãƒ‰
    function ResultCard({ bits, grade, onReset }) {
      let title = "ã‚³ã‚¤ãƒ³å·¥å ´ã®ã‚¢ãƒ«ãƒã‚¤ãƒˆ";
      if (grade.label === "S") title = "ä¼èª¬ã®é‡å­éµè·äºº";
      else if (grade.label === "A") title = "é‡å­éµã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢è¦‹ç¿’ã„";
      else if (grade.label === "B") title = "ç†Ÿç·´å·¥";

      return (
        <div className="fixed inset-0 z-50 bg-slate-950/95 backdrop-blur-sm flex items-center justify-center p-6 animate-fadeIn overflow-y-auto">
          <div className="bg-slate-900 border border-emerald-500 rounded-2xl p-6 w-full max-w-sm shadow-2xl shadow-emerald-500/20 relative">
            <div className="text-center mb-4">
              <div className="text-[10px] text-emerald-400 font-bold tracking-widest mb-1">MISSION COMPLETE</div>
              <h2 className="text-2xl font-bold text-white">éµã®ç”Ÿç”£å®Œäº†</h2>
            </div>

            <div className="bg-black/40 rounded-lg p-3 mb-4 text-center border border-slate-800">
              <div className="text-[9px] text-slate-500 mb-1">GENERATED KEY</div>
              <div className="font-mono text-lg text-cyan-300 tracking-widest break-all">{bits}</div>
            </div>

            <div className="flex items-center justify-center gap-4 mb-4 bg-slate-800/50 p-2 rounded-lg">
              <div className="text-center">
                <div className="text-[9px] text-slate-500">GRADE</div>
                <div className={`text-3xl font-bold font-tech ${grade.color.split(' ')[0]}`}>{grade.label}</div>
              </div>
              <div className="h-8 w-px bg-slate-700"></div>
              <div className="text-left">
                <div className="text-[9px] text-slate-500">ç§°å·</div>
                <div className="text-sm font-bold text-white">{title}</div>
              </div>
            </div>

            <div className="text-xs text-slate-300 text-center mb-6 bg-slate-800 p-2 rounded">
              <p className="font-bold text-emerald-400 mb-1">OSã‹ã‚‰ã®ã‚³ãƒ¡ãƒ³ãƒˆ:</p>
              {grade.feedback}
            </div>

            <div className="flex flex-col gap-3">
              <button 
                onClick={() => navigator.clipboard.writeText(`é‡å­éµå·¥å ´ã§ã€Œ${title}ã€(GRADE ${grade.label})ã®ç§°å·ã‚’ç²å¾—ã—ã¾ã—ãŸï¼ç”Ÿæˆéµ:[${bits}] #QuantumKeyFactory`)}
                className="btn-action w-full py-3 bg-sky-600 hover:bg-sky-500 text-white rounded-lg font-bold text-sm flex items-center justify-center gap-2"
              >
                <i className="ph-fill ph-twitter-logo"></i> ç§°å·ã‚’Xã§è‡ªæ…¢ã™ã‚‹
              </button>
              <button 
                onClick={onReset}
                className="btn-action w-full py-3 bg-slate-700 hover:bg-slate-600 text-slate-200 rounded-lg font-bold text-sm"
              >
                æ¬¡ã®éµã‚’ä½œã‚‹
              </button>
            </div>
          </div>
        </div>
      );
    }

    // 8. ãƒ¬ã‚·ãƒ¼ãƒˆãƒ‘ãƒãƒ«
    function ReceiptPanel({ osMode, metrics, history, measureSummary, sessionGrade }) {
      const totalOps = history.length;
      const blocked = history.filter(h => h.decision === "ãƒ–ãƒ­ãƒƒã‚¯").length;
      const totalMeas = measureSummary.total;
      const zeros = measureSummary.zeros;
      const ones  = measureSummary.ones;

      let targetLabel = "QUBIT-01";
      let p0Disp = 0;
      let p1Disp = 0;

      if (metrics.mode === "1q") {
        p0Disp = Math.round(metrics.p0 * 100);
        p1Disp = Math.round(metrics.p1 * 100);
      } else {
        p0Disp = Math.round(metrics.p0_Q1 * 100);
        p1Disp = Math.round(metrics.p1_Q1 * 100);
      }

      const summary =
        `OS=${osMode ? "ON" : "OFF"}, ` +
        `ops=${totalOps} (blocked=${blocked}), ` +
        `${targetLabel}: P(0)â‰ˆ${p0Disp}%, P(1)â‰ˆ${p1Disp}%, ` +
        `measures=${totalMeas} (0=${zeros}, 1=${ones})`;

      const shareText = sessionGrade
        ? `é‡å­OSãƒ‡ãƒ¢ã§ SESSION GRADE ${sessionGrade.label} (${sessionGrade.score}/100) ãŒå‡ºã¾ã—ãŸã€‚é‡å­ã®ã€Œé‹å‘½ã‚’ã¾ãœã‚‹ï¼†å®ˆã‚‹ã€ãƒ©ãƒœã¯ã“ã¡ã‚‰ â†’ ${window.location.href}`
        : `é‡å­OSãƒ‡ãƒ¢ã§éŠã³ã¾ã—ãŸã€‚é‡å­ã®ã€Œé‹å‘½ã‚’ã¾ãœã‚‹ï¼†å®ˆã‚‹ã€ãƒ©ãƒœã¯ã“ã¡ã‚‰ â†’ ${window.location.href}`;

      const handleCopy = () => {
        if (navigator.clipboard?.writeText) {
          navigator.clipboard.writeText(summary);
        }
      };

      const handleCopyShare = () => {
        if (navigator.clipboard?.writeText) {
          navigator.clipboard.writeText(shareText);
        }
      };

      return (
        <div className="mt-8 glass-panel p-3 rounded-xl border border-slate-700/80 bg-slate-900/80">
          <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
            <div className="flex-1">
              <div className="text-[10px] text-slate-500 font-mono mb-1">
                SESSION RECEIPT (é‡å­OSãƒ¬ã‚·ãƒ¼ãƒˆ)
              </div>
              <p className="text-[11px] text-slate-200 break-all font-mono">
                {summary}
              </p>
            </div>

            <div className="shrink-0 flex flex-col gap-2 md:self-end">
              <button
                onClick={handleCopy}
                className="px-3 py-1.5 rounded-lg bg-emerald-500 hover:bg-emerald-400 text-slate-950 text-[11px] font-semibold"
              >
                ãƒ¬ã‚·ãƒ¼ãƒˆã‚’ã‚³ãƒ”ãƒ¼
              </button>
              <button
                onClick={handleCopyShare}
                className="px-3 py-1.5 rounded-lg bg-sky-500 hover:bg-sky-400 text-slate-950 text-[11px] font-semibold"
              >
                ã‚·ã‚§ã‚¢ç”¨ãƒ†ã‚­ã‚¹ãƒˆ
              </button>
            </div>
          </div>
          <p className="mt-1 text-[10px] text-slate-400">
            ã“ã® 1 è¡Œã‚’ã‚»ãƒƒã‚·ãƒ§ãƒ³ã”ã¨ã«ä¸¦ã¹ã¦ä¿å­˜ã—ã¦ãŠã‘ã°ã€
            ã€ŒOS ãŒä½•å›æ­¢ã‚ã€ã©ã‚“ãªç¢ºç‡çŠ¶æ…‹ã§ä½•å›è¦³æ¸¬ã—ãŸã‹ã€ã‚’ç¬¬ä¸‰è€…ãŒã‚ã¨ã‹ã‚‰æ¤œè¨¼ã§ãã¾ã™ã€‚
            ADIC çš„ãªã€Œè¨¼æ‹ ãƒ¬ã‚¤ãƒ¤ãƒ¼ã€ã®ç¸®ç´„ç‰ˆã«ãªã£ã¦ã„ã¾ã™ã€‚
          </p>
        </div>
      );
    }

    // --- ã‚¢ãƒ—ãƒªæœ¬ä½“ ---
    function QuantumApp() {
      const TARGET_LENGTH = 12;
      const [mode, setMode] = useState("1q");
      const [osMode, setOsMode] = useState(true);
      const [s1, setS1] = useState({a:1, b:0});
      const [s2, setS2] = useState({a00:1, a01:0, a10:0, a11:0});
      const [gateCount, setGateCount] = useState(0);
      const [noiseCount, setNoiseCount] = useState(0);
      const [history, setHistory] = useState([]);
      const [keyBits, setKeyBits] = useState("");
      const [isFinished, setIsFinished] = useState(false);
      const [lastDecision, setLastDecision] = useState(null);
      const [measureSummary, setMeasureSummary] = useState({ total: 0, zeros: 0, ones: 0 });
      const [showIntroDetail, setShowIntroDetail] = useState(false);
      const [tutorialStep, setTutorialStep] = useState(1);

      const is1q = mode === "1q";

      const metrics = useMemo(() => is1q ? computeMetrics("1q", s1, gateCount, noiseCount) : computeMetrics("2q", s2, gateCount, noiseCount), [mode, s1, s2, gateCount, noiseCount]);

      const sessionGrade = useMemo(() => {
        const blocked = history.filter(h => h.decision === "ãƒ–ãƒ­ãƒƒã‚¯").length;
        const baseScore = metrics.safetyQ; 
        let score = Math.min(100, Math.max(0, baseScore - (blocked * 5)));
        let label="C", color="text-amber-400", feedback="OSã«ä½•åº¦ã‚‚æ­¢ã‚ã‚‰ã‚Œã¾ã—ãŸã€‚ã‚‚ã£ã¨å®‰å…¨é‹è»¢ã§ï¼";
        if(score >= 90) { 
            label="S"; color="text-emerald-400"; 
            feedback="å®Œç’§ã§ã™ï¼å±é™ºãªæ“ä½œã‚’ã›ãšã€OSã®åŸºæº–ã‚’ã‚¯ãƒªã‚¢ã—ã¦ã„ã¾ã™ã€‚"; 
        } else if(score >= 70) { 
            label="A"; color="text-cyan-400"; 
            feedback="ç´ æ™´ã‚‰ã—ã„å“è³ªã§ã™ã€‚ã»ã¼å®‰å…¨ã«é‹ç”¨ã§ãã¦ã„ã¾ã™ã€‚"; 
        } else if(score >= 50) { 
            label="B"; color="text-blue-400"; 
            feedback="åˆæ ¼ãƒ©ã‚¤ãƒ³ã§ã™ã€‚ãŸã¾ã«å±ãªã„æ“ä½œãŒã‚ã‚Šã¾ã—ãŸã€‚"; 
        }
        return { score, label, color, feedback };
      }, [metrics, history]);

      const reset = (newMode = 1) => {
        if(newMode === 1) { setS1({a:1, b:0}); } else { setS2({a00:1, a01:0, a10:0, a11:0}); }
        setGateCount(0); setNoiseCount(0); setLastDecision(null); setMeasureSummary({ total: 0, zeros: 0, ones: 0 });
        setKeyBits(""); setIsFinished(false); setHistory([]); setTutorialStep(1);
      };

      const handleScenario = (type) => {
        const op = type === "superposition" ? "ãƒ©ãƒ³ãƒ€ãƒ æ¶ˆå»" : "åŒå­ã‚³ã‚¤ãƒ³";
        if(!osMode) { setLastDecision({op: "ã‚¨ãƒ©ãƒ¼", decision: "OS OFF"}); return; }

        if(type === "superposition") {
           setS1({ a: 0.1, b: 0.99 });
           setGateCount(c => c+3);
        } else if (type === "entangle") {
           setS2({a00:0.707, a01:0, a10:0, a11:0.707});
           setGateCount(c => c+2);
        }
        setLastDecision({ op, decision: "è¨±å¯", id: Date.now() });
        setHistory(p => [...p, {op, decision: "è¨±å¯", res: "OK"}]);
        if(tutorialStep === 1) setTutorialStep(2);
      };

      const handleNoise = () => {
        const block = checkBlock(mode, metrics, gateCount, noiseCount) && osMode;
        setLastDecision({ op: "ãƒã‚¤ã‚º", decision: block ? "ãƒ–ãƒ­ãƒƒã‚¯" : "è¨±å¯", id: Date.now() });
        if(block) {
            setHistory(p => [...p, {op: "ãƒã‚¤ã‚º", decision: "ãƒ–ãƒ­ãƒƒã‚¯", res: "NG"}]);
        } else {
            if(mode==="1q") setS1(noise1q(s1)); else setS2(noise2q(s2));
            setNoiseCount(c => c+1);
            setHistory(p => [...p, {op: "ãƒã‚¤ã‚º", decision: "è¨±å¯", res: "OK"}]);
            if(tutorialStep === 1) setTutorialStep(2);
        }
      };

      const handleMeasure = () => {
        setLastDecision({ op: "è¦³æ¸¬", decision: "è¨±å¯", id: Date.now() });
        let bit = "";
        if(mode==="1q") {
          const res = measure1q(s1);
          setS1(res.next);
          bit = res.outcome.toString();
        } else {
          const res = measure2q(s2, 1);
          setS2(res.next);
          bit = res.outcome.toString();
        }
        const newKey = keyBits + bit;
        setKeyBits(newKey);
        setGateCount(0); setNoiseCount(0);
        setMeasureSummary(prev => ({ ...prev, total: prev.total+1, zeros: prev.zeros + (bit==="0"?1:0), ones: prev.ones + (bit==="1"?1:0) }));
        setHistory(prev => [{ op: "è¦³æ¸¬", decision: "è¨±å¯", res: "OK" }, ...prev].slice(0,5));
        
        if (newKey.length >= 12) setIsFinished(true);
        if(tutorialStep === 2) setTutorialStep(1);
      };

      return (
        <div className="min-h-screen bg-[radial-gradient(ellipse_at_center,_var(--tw-gradient-stops))] from-slate-900 via-[#020617] to-black text-slate-200 p-4 md:p-8 flex justify-center">
          <div className="max-w-md w-full">
            
            {/* Header */}
            <div className="mb-6 border-b border-slate-800 pb-4">
              <div className="flex flex-col gap-3">
                <h1 className="text-2xl font-bold font-sci-fi text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-purple-400">
                  QUANTUM KEY FACTORY
                </h1>
                
                {/* ã‚¤ãƒ³ãƒˆãƒ­ (å¯¾æ¯”) */}
                <div className="bg-slate-900/80 border border-slate-700/60 rounded-lg p-3 text-xs text-slate-300 leading-relaxed">
                  <div className="flex flex-col gap-2">
                    <div className="flex items-start gap-2">
                      <span className="text-[10px] bg-slate-800 text-slate-400 px-1.5 py-0.5 rounded border border-slate-700 shrink-0">æ™®é€šã®PC</span>
                      <p>0ã‹1ãŒã€Œé‹ä»»ã›ã€ã§å‡ºã‚‹ã€‚<br/><span className="text-[10px] text-slate-500">â†’ ãŸã ã®ã‚µã‚¤ã‚³ãƒ­</span></p>
                    </div>
                    <div className="flex items-start gap-2">
                      <span className="text-[10px] bg-cyan-900/30 text-cyan-300 px-1.5 py-0.5 rounded border border-cyan-800 shrink-0">ã“ã®ãƒ‡ãƒ¢</span>
                      <p>0ã¨1ã®ã€Œå‰²åˆã€ã‚’è‡ªåœ¨ã«æ“ã‚Œã‚‹ã€‚<br/><span className="text-[10px] text-cyan-200">â†’ æ„å›³çš„ã«æ“ä½œã§ãã‚‹ã€Œé­”æ³•ã®ã‚³ã‚¤ãƒ³ã€</span></p>
                    </div>
                  </div>
                  <div className="mt-3 pt-2 border-t border-slate-800 text-center">
                     <button onClick={() => setShowIntroDetail(!showIntroDetail)} className="text-[10px] text-slate-400 underline decoration-dotted">
                       {showIntroDetail ? "èª¬æ˜ã‚’ã¨ã˜ã‚‹" : "â–¶ åˆã‚ã¦ã®æ–¹ã¸ï¼šä½¿ã„æ–¹"}
                     </button>
                     {showIntroDetail && (
                       <div className="mt-2 text-left bg-slate-950 p-2 rounded animate-fadeIn">
                         <p>1. <span className="text-cyan-300">â‘ </span>ã§ã‚³ã‚¤ãƒ³ã®ç¢ºç‡ã‚’ã„ã˜ã‚Šã¾ã™ã€‚</p>
                         <p>2. <span className="text-emerald-400">â‘¡</span>ã§çµæœã‚’ç¢ºå®šï¼ˆè¦³æ¸¬ï¼‰ã—ã¾ã™ã€‚</p>
                         <p>ã“ã‚Œã‚’ç¹°ã‚Šè¿”ã—ã¦12å€‹ã®æ•°å­—ï¼ˆéµï¼‰ã‚’ä½œã‚Šã¾ã™ã€‚</p>
                       </div>
                     )}
                  </div>
                </div>
              </div>
            </div>

            <MissionHeader keyLength={12} currentLength={keyBits.length} />
            <KeyMonitor bits={keyBits} length={12} />
            
            <ControlPanel 
              mode={mode} setMode={setMode}
              metrics={metrics}
              onScenario={handleScenario}
              onNoise={handleNoise}
              onMeasure={handleMeasure}
              osMode={osMode} setOsMode={setOsMode}
              lastDecision={lastDecision}
              reset={reset}
              tutorialStep={tutorialStep}
            />

            <ReceiptPanel
              osMode={osMode}
              metrics={metrics}
              history={history}
              measureSummary={measureSummary}
              sessionGrade={sessionGrade}
            />

            <div className="mt-8 text-center border-t border-slate-800 pt-4 pb-8">
                <p className="text-slate-500 text-[10px] mb-1">"God does not play dice with the universe." - Albert Einstein</p>
                <p className="text-slate-400 text-[10px]">ã“ã‚Œã¯ã€å°†æ¥ã®ã€Œé‡å­æš—å·OSã€ã®ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ã§ã™ã€‚</p>
            </div>

          </div>
          
          {isFinished && <ResultCard bits={keyBits} grade={sessionGrade} onReset={() => reset(mode==="1q"?1:2)} />}
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<QuantumApp />);
  </script>
</body>
</html>
