<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Quantum World Key Factory: Refined Tone</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React & ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <!-- Babel -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- Phosphor Icons -->
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@400;500;600;700&family=Zen+Kaku+Gothic+New:wght@400;700&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: 'Zen Kaku Gothic New', sans-serif;
      background-color: #020617;
      color: #e2e8f0;
      overflow-x: hidden;
      background-image: 
        radial-gradient(circle at 50% 0%, rgba(124, 58, 237, 0.1), transparent 40%),
        linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px);
      background-size: 100% 100%, 40px 40px, 40px 40px;
    }
    .font-tech {
      font-family: 'Chakra Petch', sans-serif;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(5px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-fadeIn {
      animation: fadeIn 0.3s ease-out forwards;
    }

    .btn-cyber {
      position: relative;
      overflow: hidden;
      transition: all 0.2s;
      border: 1px solid rgba(148, 163, 184, 0.2);
    }
    .btn-cyber:active {
      transform: scale(0.97);
    }
    
    /* é‡å­ãƒ“ãƒƒãƒˆè¡¨ç¾ */
    .qubit-core {
      width: 90px; height: 90px;
      border-radius: 50%;
      position: relative;
      background: radial-gradient(circle at 30% 30%, rgba(6, 182, 212, 0.1), #020617);
      box-shadow: 0 0 25px rgba(6, 182, 212, 0.1), inset 0 0 15px rgba(6, 182, 212, 0.1);
      border: 1px solid rgba(6, 182, 212, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .qubit-orbit {
      position: absolute;
      width: 100%; height: 100%;
      border-radius: 50%;
      border: 1px dashed rgba(148, 163, 184, 0.2);
      animation: spin 10s linear infinite;
    }
    @keyframes spin { 100% { transform: rotate(360deg); } }

    .probability-node {
      width: 12px; height: 12px;
      background: #22d3ee;
      border-radius: 50%;
      box-shadow: 0 0 10px #22d3ee;
      transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
      z-index: 20;
    }
    
    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-track { background: #0f172a; }
    ::-webkit-scrollbar-thumb { background: #334155; border-radius: 2px; }
  </style>
</head>
<body class="antialiased text-slate-300 text-sm">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useMemo, useEffect } = React;

    // --- è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ (å¤‰æ›´ãªã—) ---
    function clamp01(x) { if (x < 0) return 0; if (x > 1) return 1; return x; }
    function normalize1q(s) { const n = Math.sqrt(s.a*s.a + s.b*s.b)||1; return { a:s.a/n, b:s.b/n }; }
    function normalize2q(s) { const n = Math.sqrt(s.a00*s.a00+s.a01*s.a01+s.a10*s.a10+s.a11*s.a11)||1; return {a00:s.a00/n,a01:s.a01/n,a10:s.a10/n,a11:s.a11/n}; }
    function noise1q(s) { return normalize1q({ a:s.a+(Math.random()-0.5)*0.8, b:s.b+(Math.random()-0.5)*0.8 }); }
    function noise2q(s) { const r=()=>(Math.random()-0.5)*0.6; return normalize2q({a00:s.a00+r(), a01:s.a01+r(), a10:s.a10+r(), a11:s.a11+r()}); }
    
    function measure1q(state) {
      const p0 = clamp01(state.a * state.a);
      const r = Math.random() < p0 ? 0 : 1;
      return { outcome: r };
    }
    function measure2q(state, idx) {
      const {a00,a01,a10,a11} = state;
      const p0 = idx===1 ? (a00*a00 + a01*a01) : (a00*a00 + a10*a10);
      const r = Math.random() < (p0||0) ? 0 : 1;
      return { outcome: r };
    }

    function computeMetrics(mode, s, g, n) {
      if (mode === "1q") {
        const p0 = clamp01(s.a*s.a), p1 = clamp01(s.b*s.b);
        const stability = Math.abs(p0 - p1); 
        const risk = clamp01(n / 10); 
        return { p0, p1, stability, risk };
      } else {
        const p0_1 = clamp01(s.a00*s.a00 + s.a01*s.a01), p1_1 = 1-p0_1;
        const p0_2 = clamp01(s.a00*s.a00 + s.a10*s.a10), p1_2 = 1-p0_2;
        const stability = Math.max(Math.abs(p0_1-p1_1), Math.abs(p0_2-p1_2));
        const ent = clamp01(4 * Math.abs(s.a00*s.a11 - s.a01*s.a10));
        const risk = clamp01((ent + n/10)/1.5);
        return { p0: p0_1, p1: p1_1, p0_2, p1_2, stability, risk, ent };
      }
    }

    // --- Level 3 Logic ---
    function createRandomRule() {
      const patterns = [
        { f0: 0, f1: 0, kind: "constant", label: "å®šæ•° (0)" },
        { f0: 1, f1: 1, kind: "constant", label: "å®šæ•° (1)" },
        { f0: 0, f1: 1, kind: "balanced", label: "å¤‰åŒ– (åŒã˜)" },
        { f0: 1, f1: 0, kind: "balanced", label: "å¤‰åŒ– (é€†)" }
      ];
      return patterns[Math.floor(Math.random() * patterns.length)];
    }

    function runQuantumScan(rule) {
      const f0 = rule.f0;
      const f1 = rule.f1;
      const H = 1 / Math.sqrt(2);
      let a00=0.0, a01=1.0, a10=0.0, a11=0.0;
      let b00=H*(a00+a10), b10=H*(a00-a10), b01=H*(a01+a11), b11=H*(a01-a11);
      let c00=H*(b00+b01), c01=H*(b00-b01), c10=H*(b10+b11), c11=H*(b10-b11);
      let d00=c00, d01=c01, d10=c10, d11=c11;
      if(f0===1){const t=d00;d00=d01;d01=t;}
      if(f1===1){const t=d10;d10=d11;d11=t;}
      let e00=H*(d00+d10), e10=H*(d00-d10), e01=H*(d01+d11), e11=H*(d01-d11);
      const p0=e00*e00+e01*e01;
      const p1=e10*e10+e11*e11;
      const kindGuess = p0 > 0.5 ? "constant" : "balanced";
      return { kindGuess, p0, p1 };
    }

    // --- UI Components ---

    function IntroModal({ onClose }) {
      return (
        <div className="fixed inset-0 z-50 bg-slate-950/95 flex items-center justify-center p-4 backdrop-blur-md animate-fadeIn">
          <div className="max-w-md w-full bg-slate-900 border border-cyan-500/30 p-6 shadow-2xl relative overflow-hidden rounded-xl">
            <h1 className="text-xl font-bold text-white mb-2 font-tech tracking-widest text-center">
              <span className="text-cyan-500">Q.W.K.</span> PROTOCOL
            </h1>
            <div className="text-[10px] font-mono text-slate-500 mb-4 border-b border-slate-800 pb-2 text-center">
              MISSION: ä¸–ç•Œæœ€å¼·ã®éµã‚’ä½œã‚Œ
            </div>
            
            <div className="space-y-3 text-xs leading-relaxed text-slate-300">
              <p>
                <span className="text-cyan-300 font-bold">é‡å­ä¸–ç•Œéµå·¥å ´</span>ã¯ã€<br/>
                <span className="font-semibold text-white">ä¸–ç•Œä¸­ã®ã€Œã²ã¿ã¤ã®éƒ¨å±‹ã€ã‚’é–‹ã‘ã‚‹éµ</span>ã‚’ä½œã‚‹ãƒ©ãƒœã§ã™ã€‚<br/>
                ã“ã®ãƒ‡ãƒ¢ã§ã¯ã€ãã®ä¸­ã§ã‚‚ãƒãƒ¬ã«ãã„ã€Œä¸–ç•Œéµã€ã‚’ä½œã‚‹ãƒ—ãƒ­ã‚»ã‚¹ã‚’ä½“é¨“ã§ãã¾ã™ã€‚
              </p>
              
              <div className="bg-slate-800/50 p-2.5 rounded border border-cyan-500/20">
                <strong className="text-cyan-400 block mb-0.5"><i className="ph-bold ph-number-circle-one"></i> é‡å­ã‚³ã‚¤ãƒ³æ“ä½œ</strong>
                <div className="text-[10px] text-slate-400">
                  ã€Œ0ã€ã¨ã€Œ1ã€ãŒ<span className="font-semibold text-slate-200">åŒæ™‚ã«å…¥ã£ãŸã‚³ã‚¤ãƒ³</span>ã‚’ä½œã£ã¦å›ã—ã¾ã™ã€‚<br/>
                  æ™®é€šã®ä¹±æ•°ã‚ˆã‚Šã‚‚ã€ãšã£ã¨ã€Œèª­ã¾ã‚Œã«ãã„ã€ã‚³ã‚¤ãƒ³ã§ã™ã€‚
                </div>
              </div>
              <div className="bg-purple-900/20 p-2.5 rounded border border-purple-500/30">
                <strong className="text-purple-400 block mb-0.5"><i className="ph-bold ph-number-circle-two"></i> é‡å­ã‚‚ã¤ã‚Œ (Lv.2)</strong>
                <div className="text-[10px] text-slate-400">
                  2ã¤ã®ã‚³ã‚¤ãƒ³ã‚’<span className="font-semibold text-purple-300">ãƒšã‚¢ã§åŒã˜å‹•ãã‚’ã™ã‚‹ã‚³ã‚¤ãƒ³</span>ã«ã—ã¾ã™ã€‚<br/>
                  ç‰‡æ–¹ã ã‘è¦‹ã¦ã‚‚ã€ã‚‚ã†ç‰‡æ–¹ã®çµæœãŒåŒæ™‚ã«æ±ºã¾ã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã™ã€‚
                </div>
              </div>

              <div className="bg-violet-950/30 p-2.5 rounded border border-violet-500/30">
                <strong className="text-violet-400 block mb-0.5">Lv.3: é‡å­é«˜é€ŸåŒ–ã®ä½“é¨“</strong>
                <div className="text-[10px] text-slate-400">
                  æ™®é€šã¯2å›ã‹ã‹ã‚‹ãƒã‚§ãƒƒã‚¯ã‚’ã€1å›ã§çµ‚ã‚ã‚‰ã›ã‚‹<span className="text-white font-bold">ã€Œè¶…é«˜é€Ÿã‚¹ã‚­ãƒ£ãƒ³ã€</span>ã‚’ä½“é¨“ã§ãã¾ã™ã€‚
                </div>
              </div>

              <div className="bg-amber-950/20 p-2 rounded border-l-2 border-amber-500 text-[10px] mt-1">
                âš ï¸ æ³¨æ„ï¼šä¸è‡ªç„¶ã«ã€Œ0ã€ã°ã‹ã‚Šå‡ºã™ã¨ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£AIã«ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã™ã€‚
              </div>
            </div>
            
            <button 
              onClick={onClose}
              className="mt-5 w-full btn-cyber py-3 bg-cyan-600/20 text-cyan-400 font-bold tracking-widest hover:bg-cyan-600/40 border-cyan-500/30 text-xs"
            >
              >> SYSTEM START
            </button>
          </div>
        </div>
      );
    }

    function QubitVisual({ p0, p1, label }) {
      const z = clamp01(p0) - clamp01(p1); 
      const topPos = 50 - (z * 40); 
      return (
        <div className="flex flex-col items-center gap-1">
           <div className="qubit-core">
             <div className="qubit-orbit"></div>
             <div className="absolute top-2 text-[8px] font-bold text-cyan-500/60">0</div>
             <div className="absolute bottom-2 text-[8px] font-bold text-purple-500/60">1</div>
             <div className="probability-node absolute left-1/2 -translate-x-1/2" style={{ top: `${topPos}%`, boxShadow: `0 0 ${10 + Math.abs(z)*10}px ${z > 0 ? '#22d3ee' : '#c084fc'}` }}></div>
           </div>
           <div className="font-tech text-[10px] text-white tracking-wider">{label}</div>
        </div>
      );
    }

    function ProbabilityBar({ p0, p1 }) {
      return (
        <div className="w-full max-w-[200px] mt-2 bg-slate-900/80 p-1.5 rounded border border-slate-700">
           <div className="flex justify-between text-[9px] font-bold text-slate-400 mb-1">
             <span className={p0 > p1 ? "text-cyan-400" : ""}>0: {Math.round(p0*100)}%</span>
             <span className={p1 > p0 ? "text-purple-400" : ""}>1: {Math.round(p1*100)}%</span>
           </div>
           <div className="h-1 w-full bg-slate-800 rounded-full overflow-hidden flex">
             <div className="h-full bg-cyan-500 transition-all duration-300" style={{ width: `${p0*100}%` }}></div>
             <div className="h-full bg-purple-500 transition-all duration-300" style={{ width: `${p1*100}%` }}></div>
           </div>
        </div>
      );
    }

    // â˜… LEVEL 3: é‡å­ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ä½“é¨“ãƒ‘ãƒãƒ« (ã‚¹ãƒãƒ›æœ€é©åŒ–ãƒ»ã‚¹ãƒˆãƒ¼ãƒªãƒ¼å¼·åŒ–)
    function Level3Panel({ onClear }) {
      const [rule, setRule] = useState(createRandomRule());
      const [classicResult, setClassicResult] = useState(null);
      const [quantumResult, setQuantumResult] = useState(null);
      const [showAnswer, setShowAnswer] = useState(false);
      const [isProcessing, setIsProcessing] = useState(false);

      const resetRule = () => {
        setRule(createRandomRule());
        setClassicResult(null);
        setQuantumResult(null);
        setShowAnswer(false);
        setIsProcessing(false);
      };

      const runClassical = () => {
        if(isProcessing) return;
        setIsProcessing(true);
        setClassicResult(null);
        setTimeout(() => {
            const kind = rule.kind;
            setClassicResult({ out0: rule.f0, out1: rule.f1, kind });
            setShowAnswer(true);
            setIsProcessing(false);
        }, 1200);
      };

      const runQuantum = () => {
        if(isProcessing) return;
        setIsProcessing(true);
        setQuantumResult(null);
        setTimeout(() => {
            const res = runQuantumScan(rule);
            setQuantumResult(res);
            setShowAnswer(true);
            if (typeof onClear === "function") onClear();
            setIsProcessing(false);
        }, 400); 
      };

      const humanKind = (k) => k === "constant" ? "ã„ã¤ã‚‚åŒã˜" : "ãƒãƒ©ãƒãƒ©";

      return (
        <div className="mt-6 relative">
          <div className="absolute -inset-0.5 bg-gradient-to-r from-violet-600 to-indigo-600 rounded-xl opacity-30 blur"></div>
          <div className="relative bg-slate-900/95 border border-indigo-500/50 rounded-xl p-4 overflow-hidden">
            
            {/* Header */}
            <div className="flex justify-between items-start gap-2 mb-3 border-b border-indigo-500/30 pb-2">
              <div className="flex-1">
                <div className="text-[9px] text-indigo-300 font-bold font-mono tracking-widest mb-0.5 flex items-center gap-1">
                  <span className="w-1.5 h-1.5 bg-violet-500 rounded-full animate-pulse"></span>
                  LEVEL 3: ä¸€å›ãƒã‚§ãƒƒã‚¯ã®é‡å­ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿
                </div>
                <h2 className="text-sm font-bold text-white flex items-center gap-1 font-tech">
                  é‡å­ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ã§ãƒ«ãƒ¼ãƒ«ã‚’ä¸€ç™ºã§è¦‹æŠœã
                </h2>
                <div className="text-[10px] text-slate-400 mt-1 leading-tight space-y-1">
                  <p>ã“ã“ã§ã¯ã€<span className="text-violet-300 font-bold">ã€Œä¸–ç•Œéµã‚’æµã™å›ç·šãŒã¡ã‚ƒã‚“ã¨ã—ã¦ã„ã‚‹ã‹ã€</span>ã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚</p>
                  <p>å›ç·šã®æ€§æ ¼ã¯2ãƒ‘ã‚¿ãƒ¼ãƒ³ã€‚ã€Œèª°ã«å¯¾ã—ã¦ã‚‚åŒã˜ç­”ãˆ (Constant)ã€ã‹ã€ã€Œç›¸æ‰‹ã«ã‚ˆã£ã¦ç­”ãˆã‚’å¤‰ãˆã‚‹ (Balanced)ã€ã‹ã€‚</p>
                  <p>æ™®é€šã®PCãªã‚‰ 0 ã¨ 1 ã® <span className="font-semibold text-slate-200">2å›ãƒã‚§ãƒƒã‚¯</span> ãŒå¿…è¦ã§ã™ãŒã€<span className="text-white bg-violet-600/30 px-1 rounded font-bold">é‡å­ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãªã‚‰ 1 å›ã®ãƒã‚§ãƒƒã‚¯</span>ã§ã©ã¡ã‚‰ã‹ã‚’è¨€ã„å½“ã¦ã‚‰ã‚Œã¾ã™ã€‚</p>
                </div>
              </div>
              <div className="text-right shrink-0 ml-1">
                <div className="text-[9px] text-slate-500 mb-1">æ­£è§£</div>
                <div className="text-[10px] font-bold text-indigo-300 mb-1 h-4">{showAnswer ? humanKind(rule.kind) : "???"}</div>
                <button onClick={resetRule} disabled={isProcessing} className="px-2 py-1 rounded bg-slate-800 text-[9px] text-slate-400 border border-slate-700">
                  <i className="ph-bold ph-arrows-clockwise"></i> ç®±ã‚’å¤‰ãˆã‚‹
                </button>
              </div>
            </div>

            <div className="grid grid-cols-2 gap-2">
              {/* Classic */}
              <div className="bg-slate-950/60 border border-slate-800 rounded p-2 flex flex-col">
                <div className="flex justify-between items-center mb-2">
                  <span className="text-[10px] font-bold text-slate-400">æ™®é€šã®PC</span>
                  <span className="text-[9px] bg-slate-800 text-slate-500 px-1 rounded">2å›å¿…è¦</span>
                </div>
                <div className="flex-1 bg-black/40 rounded p-1.5 mb-2 font-mono text-[9px] text-slate-400 h-12 overflow-hidden">
                  {classicResult ? (
                    <div className="animate-fadeIn">
                      <div>1å›ç›®: {classicResult.out0}</div>
                      <div>2å›ç›®: {classicResult.out1}</div>
                      <div className="text-emerald-400">åˆ¤å®š: {humanKind(classicResult.kind)}</div>
                    </div>
                  ) : (
                    <div className="h-full flex items-center justify-center opacity-50">{isProcessing ? "è¨ˆç®—ä¸­..." : "å¾…æ©Ÿä¸­"}</div>
                  )}
                </div>
                <button onClick={runClassical} disabled={isProcessing} className="w-full py-1.5 rounded border border-slate-700 text-slate-400 text-[10px] font-bold hover:bg-slate-800 disabled:opacity-50">
                  2å›ãƒ†ã‚¹ãƒˆ
                </button>
              </div>

              {/* Quantum */}
              <div className="bg-indigo-950/20 border border-indigo-500/30 rounded p-2 flex flex-col relative overflow-hidden">
                <div className="absolute top-0 left-0 w-full h-0.5 bg-indigo-500 shadow-[0_0_5px_#6366f1]"></div>
                <div className="flex justify-between items-center mb-2">
                  <span className="text-[10px] font-bold text-indigo-200">é‡å­PC</span>
                  <span className="text-[9px] bg-indigo-900/60 text-indigo-200 px-1 rounded font-bold">1å›ã§OK</span>
                </div>
                <div className="flex-1 bg-black/40 rounded p-1.5 mb-2 font-mono text-[9px] text-indigo-200 h-12 overflow-hidden">
                  {quantumResult ? (
                    <div className="animate-fadeIn">
                      <div className="text-indigo-300">âœ” ã‚¹ã‚­ãƒ£ãƒ³å®Œäº†</div>
                      <div className="text-[8px] text-slate-500 scale-90 origin-left">é‡ã­åˆã‚ã›å‡¦ç†...</div>
                      <div className="text-cyan-300 font-bold">åˆ¤å®š: {humanKind(quantumResult.kindGuess)}</div>
                    </div>
                  ) : (
                    <div className="h-full flex items-center justify-center opacity-50 text-indigo-500">{isProcessing ? "..." : "READY"}</div>
                  )}
                </div>
                <button onClick={runQuantum} disabled={isProcessing} className="w-full py-1.5 rounded bg-indigo-600 hover:bg-indigo-500 text-white text-[10px] font-bold shadow-lg disabled:opacity-50">
                  âš¡ 1å›ã§ã‚¹ã‚­ãƒ£ãƒ³
                </button>
              </div>
            </div>
            
            {/* ä¸–ç•Œéµå·¥å ´ã§ã®å½¹å‰² */}
            <div className="mt-3 p-2 rounded-lg bg-slate-950/80 border border-violet-500/50">
              <div className="text-[9px] font-mono text-violet-300 mb-1">
                ä¸–ç•Œéµå·¥å ´ã§ã®å½¹å‰²
              </div>
              <p className="text-[10px] text-slate-200 leading-relaxed">
                ãƒ¬ãƒ™ãƒ«1ãƒ»2ã§ä½œã£ãŸã€Œé‡å­ã‚³ã‚¤ãƒ³ã€ã€Œãƒšã‚¢ã®ã‚³ã‚¤ãƒ³ã€ã‚’çµ„ã¿åˆã‚ã›ã‚‹ã¨ã€
                å®Ÿéš›ã«ã“ã†ã„ã† <span className="font-semibold text-cyan-300">1å›ã ã‘ã®ãƒã‚§ãƒƒã‚¯</span> ãŒä½œã‚Œã¾ã™ã€‚<br/>
                ä¸–ç•Œéµã‚’ä½¿ã†å‰ã«ã€ã€Œã“ã®å›ç·šã‚„è£…ç½®ã¯ã¡ã‚ƒã‚“ã¨ã—ã¦ã„ã‚‹ã‹ï¼Ÿã€ã‚’
                ã§ãã‚‹ã ã‘çŸ­ã„ãƒã‚§ãƒƒã‚¯ã§è¦‹æŠœãâ”€â”€ãã®å¿ƒè‡“éƒ¨ãŒã€ã“ã®ãƒ¬ãƒ™ãƒ«3ã§ã™ã€‚
              </p>
            </div>
          </div>
        </div>
      );
    }

    function OSLog({ lastDecision }) {
      if (!lastDecision) return <div className="h-10 bg-slate-900/50 border-t border-slate-800 p-2 flex items-center justify-center text-slate-600 text-[10px]">[ AIç›£è¦–ä¸­ ] å¾…æ©Ÿ...</div>;
      const isBlocked = lastDecision.decision === "ãƒ–ãƒ­ãƒƒã‚¯";
      return (
        <div className={`h-10 border-t px-3 flex items-center gap-2 ${isBlocked ? "bg-red-950/20 border-red-900/50" : "bg-emerald-950/10 border-slate-800"}`}>
          <div className={isBlocked ? "text-red-500 animate-pulse" : "text-emerald-400"}><i className={isBlocked ? "ph-fill ph-warning-octagon" : "ph-fill ph-check-circle"}></i></div>
          <div className={`text-[10px] leading-tight ${isBlocked ? "text-red-200" : "text-slate-300"}`}>{lastDecision.msg}</div>
        </div>
      );
    }

    // --- ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒª ---
    function QuantumApp() {
      const TARGET_LENGTH = 12; 
      const [showIntro, setShowIntro] = useState(true);
      const [mode, setMode] = useState("1q");
      const [osMode, setOsMode] = useState(true);
      const [s1, setS1] = useState({a:1, b:0}); 
      const [s2, setS2] = useState({a00:1, a01:0, a10:0, a11:0}); 
      const [history, setHistory] = useState([]); 
      const [keyBits, setKeyBits] = useState("");
      const [isFinished, setIsFinished] = useState(false);
      const [lastDecision, setLastDecision] = useState(null);
      const [level3Cleared, setLevel3Cleared] = useState(false);

      const metrics = useMemo(() => mode === "1q" ? computeMetrics("1q", s1, 0, 0) : computeMetrics("2q", s2, 0, 0), [mode, s1, s2]);

      const reset = (newMode = 1) => {
        if(newMode === 1) setS1({a:1, b:0}); else setS2({a00:1, a01:0, a10:0, a11:0});
        setLastDecision(null); setKeyBits(""); setIsFinished(false); setHistory([]); setLevel3Cleared(false);
      };

      const copyToClipboard = (text) => {
        const t = document.createElement("textarea"); t.value = text; document.body.appendChild(t); t.select();
        try { document.execCommand('copy'); } catch (e) {} document.body.removeChild(t);
      };

      const handleBias = () => {
        if (osMode && metrics.stability > 0.8) {
           setLastDecision({ decision: "ãƒ–ãƒ­ãƒƒã‚¯", msg: "è­¦å‘Šï¼š0ã«åã‚Šã™ãã§ã™ï¼æ€ªã—ã¾ã‚Œã¾ã™ã€‚", id: Date.now() });
           setHistory(p => [...p, "åã‚Šã™ã"]); return;
        }
        if(mode === "1q") setS1({ a: 0.95, b: 0.31 }); else setS2({ a00:0.9, a01:0.1, a10:0.1, a11:0.4 });
        setLastDecision({ decision: "è¨±å¯", msg: "ç£çŸ³ã§ã€Œ0ã€ãŒå‡ºã‚„ã™ãã—ã¾ã—ãŸã€‚", id: Date.now() });
      };

      const handleHadamard = () => {
        if(mode === "1q") setS1({ a: 0.7071, b: 0.7071 }); else setS2({ a00:0.5, a01:0.5, a10:0.5, a11:0.5 }); 
        setLastDecision({ decision: "è¨±å¯", msg: "ç¢ºç‡ã‚’å…¬å¹³(50:50)ã«æ··ãœã¾ã—ãŸã€‚", id: Date.now() });
      };

      const handleEntangle = () => {
        if (mode === "1q") return;
        setS2({a00:0.707, a01:0, a10:0, a11:0.707}); 
        setLastDecision({ decision: "è¨±å¯", msg: "2ã¤ã‚’é‹å‘½ãƒªãƒ³ã‚¯ã•ã›ã¾ã—ãŸã€‚", id: Date.now() });
      };

      const handleNoise = () => {
        if(mode==="1q") setS1(noise1q(s1)); else setS2(noise2q(s2));
        setLastDecision({ decision: "è¨±å¯", msg: "æºã‚‰ã—ã¦å°‘ã—æ··ãœã¾ã—ãŸã€‚", id: Date.now() });
      };

      const handleMeasure = () => {
        if (osMode && metrics.stability > 0.92) {
             setLastDecision({ decision: "ãƒ–ãƒ­ãƒƒã‚¯", msg: "ãƒãƒ¬ãƒãƒ¬ã§ã™ï¼ã‚‚ã£ã¨ãƒ©ãƒ³ãƒ€ãƒ ã«ã—ã¦ã€‚", id: Date.now() });
             setHistory(p => [...p, "äºˆæ¸¬å¯èƒ½"]); return;
        }
        let bit = "";
        if(mode==="1q") { const r = measure1q(s1); bit = r.outcome.toString(); } 
        else { const r = measure2q(s2, 1); bit = r.outcome.toString(); }
        const newKey = keyBits + bit;
        setKeyBits(newKey);
        setLastDecision({ decision: "è¨±å¯", msg: `ã‚¹ãƒˆãƒƒãƒ—ï¼ã€Œ${bit}ã€ã§ç¢ºå®šã—ã¾ã—ãŸã€‚`, id: Date.now() });
        if (newKey.length >= TARGET_LENGTH) setIsFinished(true);
      };

      return (
        <div className="min-h-screen flex justify-center bg-[#020617] pb-24">
          {showIntro && <IntroModal onClose={() => setShowIntro(false)} />}
          
          <div className="w-full max-w-md p-4 flex flex-col">
            {/* Header */}
            <div className="flex justify-between items-end border-b border-slate-800 pb-3 mb-2">
              <div>
                <h1 className="text-xl font-bold text-white tracking-widest font-tech flex gap-2 items-center"><i className="ph-fill ph-fingerprint text-cyan-500"></i> KEY FACTORY</h1>
                <p className="text-[9px] text-cyan-700 font-bold tracking-widest">SECURE PROTOCOL v9.0</p>
              </div>
              <div className="text-right">
                <div className="text-[9px] text-slate-500">PROGRESS</div>
                <div className="text-lg font-bold text-cyan-400 font-mono leading-none">{keyBits.length}<span className="text-xs text-slate-600">/{TARGET_LENGTH}</span></div>
              </div>
            </div>
            
            {/* è¿½åŠ : ãƒ¡ã‚¤ãƒ³ç”»é¢ãƒ˜ãƒƒãƒ€ãƒ¼ä¸‹ã®ã‚¹ãƒˆãƒ¼ãƒªãƒ¼èª¬æ˜ */}
            <p className="text-[11px] text-slate-400 mb-4 leading-tight">
              ä¸Šã‹ã‚‰é †ã«ã€<span className="font-semibold text-cyan-200">ãƒ¬ãƒ™ãƒ«1ãƒ»2ã§éµã®1ãƒ“ãƒƒãƒˆãšã¤ã‚’ä½œã‚Š</span>ã€
              <span className="font-semibold text-violet-200">ãƒ¬ãƒ™ãƒ«3ã§ã€Œä¸–ç•ŒãŒã¡ã‚ƒã‚“ã¨ã—ã¦ã„ã‚‹ã‹ã€ã‚’ä¸€å›ã§ãƒã‚§ãƒƒã‚¯</span>ã™ã‚‹å·¥å ´ã§ã™ã€‚
            </p>

            {/* Mode Tabs */}
            <div className="flex gap-1 mb-4 bg-slate-900/50 p-1 rounded border border-slate-800">
              <button onClick={() => { setMode("1q"); reset(1); }} className={`flex-1 py-2 rounded text-[10px] font-bold flex items-center justify-center gap-1 ${mode==="1q" ? "bg-cyan-900/30 text-cyan-300" : "text-slate-500"}`}>
                <i className="ph-bold ph-circle"></i> Lv.1 ã‚³ã‚¤ãƒ³
              </button>
              <button onClick={() => { setMode("2q"); reset(2); }} className={`flex-1 py-2 rounded text-[10px] font-bold flex items-center justify-center gap-1 ${mode==="2q" ? "bg-purple-900/30 text-purple-300" : "text-slate-500"}`}>
                <i className="ph-bold ph-circles-three"></i> Lv.2 ãƒšã‚¢
              </button>
            </div>

            {/* Visualizer */}
            <div className="bg-slate-950/50 border border-slate-800 rounded-xl p-4 mb-4 flex flex-col items-center relative overflow-hidden min-h-[160px] justify-center">
               <div className="flex gap-6 z-10 scale-90">
                 {mode === "1q" ? <QubitVisual p0={metrics.p0} p1={metrics.p1} label="QUBIT" /> : 
                   <><QubitVisual p0={metrics.p0} p1={metrics.p1} label="A (å…„)" /><QubitVisual p0={metrics.p0_2} p1={metrics.p1_2} label="B (å¼Ÿ)" /></>}
               </div>
               <ProbabilityBar p0={mode==="1q" ? metrics.p0 : metrics.p0} p1={mode==="1q" ? metrics.p1 : metrics.p1} />
            </div>

            {/* Controls */}
            <div className="grid grid-cols-2 gap-3 mb-2">
              <div className="col-span-1 space-y-2">
                <div className="text-[9px] font-bold text-cyan-500 border-b border-cyan-900/30 pb-1">â‘  ç¢ºç‡ã‚’ä½œã‚‹</div>
                <button onClick={handleHadamard} className="btn-cyber w-full bg-slate-800 p-2 text-left rounded flex items-center gap-2">
                  <div className="text-cyan-400 text-lg"><i className="ph-bold ph-arrows-clockwise"></i></div>
                  <div><div className="text-[10px] font-bold text-white">å…¬å¹³ã«æ··ãœã‚‹</div><div className="text-[8px] text-slate-500">50:50ã«ã™ã‚‹</div></div>
                </button>
                <button onClick={handleBias} className="btn-cyber w-full bg-slate-800 p-2 text-left rounded flex items-center gap-2">
                  <div className="text-amber-400 text-lg"><i className="ph-bold ph-magnet"></i></div>
                  <div><div className="text-[10px] font-bold text-white">0ã«åã‚‰ã›ã‚‹</div><div className="text-[8px] text-slate-500">ç£çŸ³ã‚’ä½¿ã†</div></div>
                </button>
                {mode==="2q" && <button onClick={handleEntangle} className="btn-cyber w-full bg-slate-800 p-2 text-left rounded flex items-center gap-2 border-purple-500/30">
                  <div className="text-purple-400 text-lg"><i className="ph-bold ph-infinity"></i></div>
                  <div><div className="text-[10px] font-bold text-purple-200">é‹å‘½ã‚’ãƒªãƒ³ã‚¯</div><div className="text-[8px] text-slate-500">ã‚·ãƒ³ã‚¯ãƒ­ã•ã›ã‚‹</div></div>
                </button>}
                <button onClick={handleNoise} className="btn-cyber w-full bg-slate-800 p-2 text-left rounded flex items-center gap-2">
                  <div className="text-slate-400 text-lg"><i className="ph-bold ph-hand-waving"></i></div>
                  <div><div className="text-[10px] font-bold text-white">é©å½“ã«æºã‚‰ã™</div><div className="text-[8px] text-slate-500">ã”ã¡ã‚ƒæ··ãœ</div></div>
                </button>
              </div>
              <div className="col-span-1 space-y-2 flex flex-col">
                <div className="text-[9px] font-bold text-emerald-500 border-b border-emerald-900/30 pb-1">â‘¡ æ±ºã‚ã‚‹</div>
                <button onClick={handleMeasure} className="flex-1 btn-cyber bg-emerald-900/20 border-emerald-500/30 flex flex-col items-center justify-center p-2 rounded-xl active:bg-emerald-800/40">
                  <i className="ph-bold ph-hand-palm text-3xl text-emerald-500 mb-1"></i>
                  <span className="text-sm font-bold text-white">ã‚¹ãƒˆãƒƒãƒ—ï¼</span>
                  <span className="text-[9px] text-emerald-400">æ•°å­—ã‚’ç¢ºå®šã™ã‚‹</span>
                </button>
              </div>
            </div>

            {/* Key Monitor & Log */}
            <div className="bg-black border border-slate-800 rounded-t p-2 mb-0">
               <div className="text-[9px] text-slate-500">GENERATED KEY</div>
               <div className="text-lg font-mono text-cyan-400 tracking-widest break-all leading-none">{keyBits || "..."}</div>
            </div>
            <OSLog lastDecision={lastDecision} />

            {/* Level 3 */}
            <Level3Panel onClear={() => setLevel3Cleared(true)} />

            {/* OS Badge */}
            <div className="mt-6 flex justify-between items-center bg-slate-900/50 p-2 rounded border border-slate-800">
               <div className="text-[9px] text-slate-500 flex items-center gap-1"><i className="ph-fill ph-robot"></i> AIç›£è¦–ã‚·ã‚¹ãƒ†ãƒ </div>
               <button onClick={() => setOsMode(!osMode)} className={`text-[9px] px-2 py-0.5 rounded border ${osMode ? "text-emerald-500 border-emerald-900" : "text-red-500 border-red-900"}`}>
                 {osMode ? "ON" : "OFF"}
               </button>
            </div>
          </div>

          {/* Result Overlay */}
          {isFinished && (
            <div className="fixed inset-0 z-50 bg-black/95 flex items-center justify-center p-6 animate-fadeIn">
               <div className="w-full max-w-sm border border-emerald-500/50 p-6 bg-slate-900 rounded-xl relative overflow-hidden">
                 <div className="absolute top-0 left-0 w-full h-1 bg-emerald-500"></div>
                 <div className="text-center mb-4">
                   <div className="text-emerald-500 text-3xl mb-1"><i className="ph-fill ph-certificate"></i></div>
                   <h2 className="text-xl font-bold text-white">MISSION COMPLETE</h2>
                 </div>
                 <div className="bg-black p-3 rounded mb-4 border border-slate-800 text-center">
                   <div className="text-[9px] text-slate-500 mb-1">FINAL KEY</div>
                   <div className="text-xl font-mono text-cyan-300 tracking-widest select-all">{keyBits}</div>
                 </div>
                 <div className={`p-3 mb-4 rounded text-xs border ${history.length === 0 ? "bg-emerald-950/30 border-emerald-500/30 text-emerald-200" : "bg-amber-950/30 border-amber-500/30 text-amber-200"}`}>
                    <div className="font-bold mb-1">{history.length === 0 ? "è©•ä¾¡: S (å®Œç’§)" : `è©•ä¾¡: B (è­¦å‘Š${history.length}å›)`}</div>
                    <div>{history.length === 0 ? "AIã®ç›£è¦–ã‚’å®Œå…¨ã«ã‹ã„ããã‚Šã¾ã—ãŸã€‚" : "å°‘ã—æ€ªã—ã„å‹•ããŒã‚ã‚Šã¾ã—ãŸãŒæˆåŠŸã§ã™ã€‚"}</div>
                    {level3Cleared && (
                      <div className="mt-2 pt-2 border-t border-white/10 flex items-center gap-2">
                        <span className="text-lg">ğŸ†</span>
                        <div>
                          <div className="text-[9px] text-violet-300 font-bold uppercase">Award</div>
                          <div className="text-[10px] font-bold text-white">é‡å­ã‚¹ã‚­ãƒ£ãƒ³ä½“é¨“æ¸ˆ</div>
                        </div>
                      </div>
                    )}
                 </div>
                 <div className="grid grid-cols-2 gap-3">
                    <button onClick={() => reset(1)} className="btn-cyber py-2 bg-slate-800 text-xs font-bold text-slate-300 rounded">ç ´æ£„</button>
                    <button onClick={() => copyToClipboard(keyBits)} className="btn-cyber py-2 bg-emerald-600 text-xs font-bold text-white border-emerald-500 rounded">ã‚³ãƒ”ãƒ¼ã—ã¦çµ‚äº†</button>
                 </div>
               </div>
            </div>
          )}
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<QuantumApp />);
  </script>
</body>
</html>
