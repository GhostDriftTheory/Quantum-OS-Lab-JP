<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Quantum Core: é‡å­ä¸–ç•Œã¸ã®æ—…</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <!-- OG / Twitter ã‚«ãƒ¼ãƒ‰è¨­å®š -->
  <meta property="og:type" content="website" />
  <meta property="og:title" content="Quantum Core: é‡å­ä¸–ç•Œã¸ã®æ—…ï¼ˆé‡å­OSãƒ©ãƒœï¼‰" />
  <meta property="og:description" content="é‡å­ã®ã€Œé‹å‘½ã‚’ã¾ãœã‚‹ï¼†1å›ã ã‘æ±ºã‚ã‚‹ã€ã‚’ã€é‡å­OSä»˜ãã§å®‰å…¨ã«ä½“é¨“ã§ãã‚‹ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãƒ»ãƒ©ãƒœã§ã™ã€‚SESSION GRADE ã‚„é‡å­ãƒ©ãƒ³ãƒ€ãƒ éµã‚‚ç”Ÿæˆã§ãã¾ã™ã€‚" />
  <meta property="og:url" content="https://ghostdrifttheory.github.io/Quantum-Core-Quantum-OS-Lab/" />
  <!-- â˜…ã“ã“ã« 1792Ã—1024 ã®OGãƒãƒŠãƒ¼ç”»åƒã‚’ç½®ãï¼ˆé‡å­ç‰ï¼‹OSï¼‹GRADE Sï¼‰ -->
  <meta property="og:image" content="https://ghostdrifttheory.github.io/Quantum-Core-Quantum-OS-Lab/quantum-os-og-1792x1024.png" />
  <meta property="og:image:alt" content="Quantum OS ãƒ©ãƒœï¼šé‡å­ã®ç‰ã€OSã‚·ãƒ¼ãƒ«ãƒ‰ã€SESSION GRADE S ã®ãƒãƒƒã‚¸" />
  <meta name="twitter:card" content="summary_large_image" />

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React & ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <!-- Babel -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- Phosphor Icons (ã‚¢ã‚¤ã‚³ãƒ³ç”¨) -->
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
  <!-- Google Fonts (SFã£ã½ã„ãƒ•ã‚©ãƒ³ãƒˆ) -->
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Zen+Kaku+Gothic+New:wght@400;700&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: 'Zen Kaku Gothic New', sans-serif;
      background-color: #020617; /* Slate 950 */
      color: #f8fafc;
      overflow-x: hidden;
    }
    .font-sci-fi {
      font-family: 'Orbitron', sans-serif;
    }
    
    /* é‡å­ãƒ“ãƒƒãƒˆã®çƒä½“è¡¨ç¾ */
    .qubit-sphere {
      width: 180px;
      height: 180px;
      border-radius: 50%;
      position: relative;
      /* å®‡å®™ã£ã½ã„ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ */
      background: radial-gradient(circle at 30% 30%, rgba(56, 189, 248, 0.2), rgba(2, 6, 23, 1));
      box-shadow: 0 0 30px rgba(56, 189, 248, 0.1), inset 0 0 20px rgba(56, 189, 248, 0.1);
      border: 1px solid rgba(56, 189, 248, 0.3);
      overflow: hidden;
      transition: all 0.5s ease;
    }
    
    .qubit-sphere::before {
      content: "";
      position: absolute;
      top: 50%; left: 0; right: 0;
      height: 1px;
      background: rgba(148, 163, 184, 0.3); /* èµ¤é“ */
    }
    .qubit-sphere::after {
      content: "";
      position: absolute;
      left: 50%; top: 0; bottom: 0;
      width: 1px;
      background: rgba(148, 163, 184, 0.3); /* å­åˆç·š */
    }

    /* çŠ¶æ…‹ã‚’è¡¨ã™å…‰ã‚‹ç‚¹ */
    .qubit-soul {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: radial-gradient(circle, #ffffff, #22d3ee);
      box-shadow: 0 0 15px #22d3ee, 0 0 30px #22d3ee;
      position: absolute;
      transform: translate(-50%, -50%);
      transition: top 0.4s cubic-bezier(0.34, 1.56, 0.64, 1), left 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      z-index: 10;
    }

    /* ç¢ºç‡ã®ã‚†ã‚‰ãã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    @keyframes pulse-glow {
      0%, 100% { opacity: 0.6; box-shadow: 0 0 10px currentColor; }
      50% { opacity: 1; box-shadow: 0 0 20px currentColor; }
    }
    .animate-pulse-glow {
      animation: pulse-glow 2s infinite;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-5px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-fadeIn {
      animation: fadeIn 0.5s ease-out forwards;
    }

    /* ã‚°ãƒ©ã‚¹ãƒ¢ãƒ¼ãƒ•ã‚£ã‚ºãƒ ãƒ‘ãƒãƒ« */
    .glass-panel {
      background: rgba(15, 23, 42, 0.6);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(148, 163, 184, 0.1);
      box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
    }

    /* ãƒœã‚¿ãƒ³ã®ãƒ›ãƒãƒ¼ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
    .btn-action {
      transition: all 0.2s;
    }
    .btn-action:active {
      transform: scale(0.95);
    }
    
    /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ */
    .custom-scrollbar::-webkit-scrollbar {
      width: 6px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
      background: rgba(15, 23, 42, 0.5);
      border-radius: 4px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
      background: rgba(56, 189, 248, 0.3);
      border-radius: 4px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
      background: rgba(56, 189, 248, 0.5);
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useMemo, useEffect, useRef } = React;

    // ==========================================
    //  æ—¢å­˜ã®è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ (å¤‰æ›´ãªã—/ã‚³ã‚¢ã‚¨ãƒ³ã‚¸ãƒ³)
    // ==========================================
    function clamp01(x) {
      if (x < 0) return 0;
      if (x > 1) return 1;
      return x;
    }
    // ===== 1é‡å­ãƒ“ãƒƒãƒˆçŠ¶æ…‹ =====
    function normalize1q(s) {
      const { a, b } = s;
      const n2 = a * a + b * b;
      if (!n2 || !isFinite(n2)) return { a: 1, b: 0 };
      const n = Math.sqrt(n2);
      return { a: a / n, b: b / n };
    }
    function gateH1q(s) {
      const r = 1 / Math.sqrt(2);
      const a = r * (s.a + s.b);
      const b = r * (s.a - s.b);
      return normalize1q({ a, b });
    }
    function gateX1q(s) {
      return normalize1q({ a: s.b, b: s.a });
    }
    function gateZ1q(s) {
      return normalize1q({ a: s.a, b: -s.b });
    }
    function noise1q(s) {
      const da = (Math.random() - 0.5) * 0.4;
      const db = (Math.random() - 0.5) * 0.4;
      return normalize1q({ a: s.a + da, b: s.b + db });
    }
    // ===== 2é‡å­ãƒ“ãƒƒãƒˆçŠ¶æ…‹ =====
    function normalize2q(s) {
      const { a00, a01, a10, a11 } = s;
      const n2 = a00 * a00 + a01 * a01 + a10 * a10 + a11 * a11;
      if (!n2 || !isFinite(n2)) return { a00: 1, a01: 0, a10: 0, a11: 0 };
      const n = Math.sqrt(n2);
      return { a00: a00 / n, a01: a01 / n, a10: a10 / n, a11: a11 / n };
    }
    function gateH2q_Q1(s) {
      const r = 1 / Math.sqrt(2);
      return normalize2q({
        a00: r * (s.a00 + s.a10), a01: r * (s.a01 + s.a11),
        a10: r * (s.a00 - s.a10), a11: r * (s.a01 - s.a11)
      });
    }
    function gateH2q_Q2(s) {
      const r = 1 / Math.sqrt(2);
      return normalize2q({
        a00: r * (s.a00 + s.a01), a01: r * (s.a00 - s.a01),
        a10: r * (s.a10 + s.a11), a11: r * (s.a10 - s.a11)
      });
    }
    function gateX2q_Q1(s) { return normalize2q({ a00: s.a10, a01: s.a11, a10: s.a00, a11: s.a01 }); }
    function gateX2q_Q2(s) { return normalize2q({ a00: s.a01, a01: s.a00, a10: s.a11, a11: s.a10 }); }
    function gateZ2q_Q1(s) { return normalize2q({ a00: s.a00, a01: s.a01, a10: -s.a10, a11: -s.a11 }); }
    function gateZ2q_Q2(s) { return normalize2q({ a00: s.a00, a01: -s.a01, a10: s.a10, a11: -s.a11 }); }
    function gateCNOT_Q1toQ2(s) { return normalize2q({ a00: s.a00, a01: s.a01, a10: s.a11, a11: s.a10 }); }
    function noise2q(s) {
      const r = () => (Math.random() - 0.5) * 0.3;
      return normalize2q({ a00: s.a00 + r(), a01: s.a01 + r(), a10: s.a10 + r(), a11: s.a11 + r() });
    }
    function measure1q(state) {
      const p0 = clamp01(state.a * state.a);
      const r = Math.random() < p0 ? 0 : 1;
      return { next: r === 0 ? { a: 1, b: 0 } : { a: 0, b: 1 }, outcome: r };
    }
    function measure2q(state, qubitIndex) {
      const { a00, a01, a10, a11 } = state;
      const p00=a00*a00, p01=a01*a01, p10=a10*a10, p11=a11*a11;
      if (qubitIndex === 1) {
        const p0 = p00 + p01;
        const r = Math.random() < (p0 || 0) ? 0 : 1;
        if (r === 0) return { next: normalize2q({ a00, a01, a10: 0, a11: 0 }), outcome: 0 };
        else return { next: normalize2q({ a00: 0, a01, a10, a11 }), outcome: 1 };
      } else {
        const p0 = p00 + p10;
        const r = Math.random() < (p0 || 0) ? 0 : 1;
        if (r === 0) return { next: normalize2q({ a00, a01: 0, a10, a11: 0 }), outcome: 0 };
        else return { next: normalize2q({ a00: 0, a01, a10, a11 }), outcome: 1 };
      }
    }
    // ãƒ¡ãƒˆãƒªã‚¯ã‚¹è¨ˆç®—
    function computeMetrics1q(state, gateCount, noiseCount) {
      const p0 = clamp01(state.a * state.a);
      const p1 = clamp01(state.b * state.b);
      const stability = Math.abs(p0 - p1);
      const riskQuantum = clamp01(noiseCount / 8);
      return {
        mode: "1q", p0, p1, p0_Q1: p0, p1_Q1: p1, p0_Q2: null, p1_Q2: null,
        entanglement: 0, stability, riskQuantum,
        safetyClassical: Math.round(stability * 100),
        safetyQuantum: Math.round((1 - riskQuantum) * 100),
        gateCount, noiseCount
      };
    }
    function computeMetrics2q(state, gateCount, noiseCount) {
      const { a00, a01, a10, a11 } = state;
      const p00=a00*a00, p01=a01*a01, p10=a10*a10, p11=a11*a11;
      const p0_Q1 = clamp01(p00 + p01), p1_Q1 = clamp01(p10 + p11);
      const p0_Q2 = clamp01(p00 + p10), p1_Q2 = clamp01(p01 + p11);
      const stability = Math.max(Math.abs(p0_Q1 - p1_Q1), Math.abs(p0_Q2 - p1_Q2));
      const ent = clamp01(4 * Math.abs(a00 * a11 - a01 * a10));
      const riskQuantum = clamp01((ent + noiseCount / 8) / 1.5);
      return {
        mode: "2q", p0: p0_Q1, p1: p1_Q1, p0_Q1, p1_Q1, p0_Q2, p1_Q2,
        entanglement: ent, stability, riskQuantum,
        safetyClassical: Math.round(stability * 100),
        safetyQuantum: Math.round((1 - riskQuantum) * 100),
        gateCount, noiseCount
      };
    }
    function shouldBlockOperation(metrics, osMode, opKey) {
      if (!osMode) return false;
      if (opKey.startsWith("measure") || opKey.startsWith("reset") || opKey.startsWith("scenario")) return false;
      const g = metrics.gateCount, nq = metrics.noiseCount;
      if (metrics.mode === "1q") {
        if (metrics.stability < 0.2 && g >= 8) return true;
        if (metrics.riskQuantum > 0.7 && (g >= 6 || nq >= 5)) return true;
      } else {
        if (metrics.riskQuantum > 0.6 && (g >= 6 || nq >= 4)) return true;
        if (metrics.stability < 0.2 && metrics.entanglement > 0.5 && g >= 4) return true;
      }
      return false;
    }

    // ==========================================
    //  æ–°ã—ã„ UI ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
    // ==========================================

    // 1. é‡å­ãƒ“ãƒƒãƒˆãƒ“ã‚¸ãƒ¥ã‚¢ãƒ©ã‚¤ã‚¶ãƒ¼ï¼ˆçƒä½“ï¼‰
    function QubitSphere({ p0, p1, label }) {
      const z = clamp01(p0) - clamp01(p1);
      const midX = 50; 
      const midY = 50 - (z * 40);

      return (
        <div className="flex flex-col items-center group">
          <div className="relative mb-4">
            <div className="qubit-sphere">
              <div 
                className="qubit-soul"
                style={{ left: `${midX}%`, top: `${midY}%` }}
              />
              <div className="absolute top-2 left-0 right-0 text-center text-[10px] text-slate-500 font-mono">|0&gt; (è¡¨)</div>
              <div className="absolute bottom-2 left-0 right-0 text-center text-[10px] text-slate-500 font-mono">|1&gt; (è£)</div>
            </div>
          </div>
          <div className="font-sci-fi text-cyan-400 tracking-wider text-sm">{label || "QUBIT"}</div>
        </div>
      );
    }

    // 2. ç¢ºç‡ãƒãƒ¼
    function ProbBar({ p0, p1, label }) {
      const pct0 = Math.round(clamp01(p0) * 100);
      const pct1 = Math.round(clamp01(p1) * 100);

      return (
        <div className="w-full bg-slate-900/50 p-3 rounded-lg border border-slate-700/50">
          <div className="flex justify-between items-end mb-2">
            <span className="text-xs text-slate-400 font-mono">{label || "PROBABILITY"}</span>
            <span className="text-xs text-cyan-200">
              {pct0 === 50 && pct1 === 50 ? "SUPERPOSITION (é‡ã­åˆã‚ã›)" : pct0 > pct1 ? "0 æœ‰åŠ›" : "1 æœ‰åŠ›"}
            </span>
          </div>
          <div className="relative h-6 w-full flex rounded-sm overflow-hidden bg-slate-800">
            <div 
              style={{ width: `${pct0}%` }} 
              className="h-full bg-gradient-to-r from-blue-600 to-cyan-500 relative transition-all duration-300"
            >
              {pct0 > 20 && <span className="absolute left-2 top-1/2 -translate-y-1/2 text-[10px] font-bold text-slate-900">0: {pct0}%</span>}
            </div>
            <div 
              style={{ width: `${pct1}%` }} 
              className="h-full bg-gradient-to-r from-purple-600 to-pink-500 relative transition-all duration-300"
            >
              {pct1 > 20 && <span className="absolute right-2 top-1/2 -translate-y-1/2 text-[10px] font-bold text-white">1: {pct1}%</span>}
            </div>
          </div>
        </div>
      );
    }

    // 3. AI ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆï¼ˆè¦ã™ã‚‹ã«çŸ­ç¸®ç‰ˆï¼‰
    function AssistantMessage({ lastDecision, osMode, metrics }) {
      let message = "ã‚·ã‚¹ãƒ†ãƒ å¾…æ©Ÿä¸­ã§ã™ã€‚ã©ã‚Œã‹ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã¿ã¦ãã ã•ã„ã€‚";
      let mood = "neutral"; 

      if (lastDecision) {
        if (lastDecision.decision === "ãƒ–ãƒ­ãƒƒã‚¯") {
          message = "âš ï¸ å±é™ºã¨åˆ¤æ–­ã—ãŸã®ã§ã€é‡å­OSãŒã“ã®æ“ä½œã‚’æ­¢ã‚ã¾ã—ãŸã€‚";
          mood = "danger";
        } else if (lastDecision.op.includes("æ¸¬å®š")) {
          message = "è¦³æ¸¬ã—ã¾ã—ãŸã€‚å¯èƒ½æ€§ãŒ 1 ã¤ã«æ±ºã¾ã‚Šã¾ã—ãŸã€‚";
          mood = "neutral";
        } else if (metrics.entanglement > 0.8) {
          message = "å¼·ã„ã€Œé‡å­ã®ã‚‚ã¤ã‚Œã€ãŒã§ãã¦ã„ã¾ã™ã€‚ã‹ãªã‚Šãƒ¬ã‚¢ãªçŠ¶æ…‹ã§ã™ã€‚";
          mood = "happy";
        } else if (metrics.stability < 0.1 && metrics.gateCount > 0) {
          message = "ã€Œé‡ã­åˆã‚ã›ã€çŠ¶æ…‹ã§ã™ã€‚ã‚³ã‚¤ãƒ³ãŒé«˜é€Ÿå›è»¢ã—ã¦ã„ã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã™ã€‚";
          mood = "happy";
        } else {
          message = "æ“ä½œã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸã€‚é‡å­çŠ¶æ…‹ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚";
        }
      } else if (osMode) {
        message = "ğŸ›¡ï¸ é‡å­OS ãŒ ON ã§ã™ã€‚å±ãªãã†ãªæ“ä½œã¯è‡ªå‹•ã§ãƒ–ãƒ­ãƒƒã‚¯ã—ã¾ã™ã€‚";
        mood = "happy";
      }

      const colorClass = mood === "danger" ? "text-rose-300 border-rose-500/50 bg-rose-950/30" : 
                         mood === "happy" ? "text-cyan-200 border-cyan-500/50 bg-cyan-950/30" : 
                         "text-slate-300 border-slate-600 bg-slate-900/50";

      return (
        <div className={`mt-4 p-4 rounded-xl border ${colorClass} transition-all duration-500`}>
          <div className="flex items-start gap-3">
            <div className="text-2xl mt-1">
              {mood === "danger" ? <i className="ph-fill ph-warning-octagon text-rose-500"></i> : 
               mood === "happy" ? <i className="ph-fill ph-sparkle text-cyan-400"></i> : 
               <i className="ph-fill ph-robot text-slate-400"></i>}
            </div>
            <div>
              <div className="text-[10px] opacity-70 mb-1 font-mono uppercase tracking-widest">Quantum OS Navigator</div>
              <p className="text-sm leading-relaxed font-medium">{message}</p>
            </div>
          </div>
        </div>
      );
    }

    // 4. åˆå¿ƒè€…ç”¨ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚«ãƒ¼ãƒ‰ï¼ˆä¸€è¡Œè¦ç´„ç‰ˆï¼‰
    function MissionCard({ metrics, osMode }) {
      const clear =
        osMode &&
        metrics.safetyClassical >= 80 &&
        metrics.safetyQuantum >= 70;

      return (
        <div className={`mb-4 p-3 rounded-xl bg-slate-900/80 border transition-colors duration-500 ${clear ? "border-emerald-500 shadow-[0_0_15px_rgba(16,185,129,0.3)]" : "border-emerald-600/60"}`}>
          <div className="text-[11px] font-semibold text-emerald-200 mb-1 flex items-center gap-2">
            <span>ğŸ¯ ä»Šæ—¥ã®ãƒŸãƒƒã‚·ãƒ§ãƒ³ï¼ˆåˆç´šï¼‰</span>
            {clear && (
              <span className="px-2 py-0.5 rounded-full bg-emerald-500 text-slate-950 text-[10px] animate-pulse">
                CLEAR!
              </span>
            )}
          </div>
          <p className="text-[11px] text-slate-200 leading-relaxed">
            è¦ã™ã‚‹ã«ï¼š
            <span className="font-semibold"> OSãƒ¢ãƒ¼ãƒ‰ã®ã¾ã¾ã€å¤å…¸å®‰å…¨åº¦ 80%ä»¥ä¸Šãƒ»é‡å­å®‰å…¨åº¦ 70%ä»¥ä¸Š</span>
            ã«ã—ã¦ã‹ã‚‰ã€Œè¦³æ¸¬ã—ã¦é‹å‘½ã‚’æ±ºã‚ã‚‹ã€ã‚’ 1 å›æŠ¼ã™ã ã‘ã§ã™ã€‚
          </p>
          {!clear && (
            <p className="mt-1 text-[10px] text-slate-400">
              ãƒ¡ãƒ¼ã‚¿ãƒ¼ã‚’ãƒãƒ©è¦‹ã—ãªãŒã‚‰ã€Quick Scenarios ã¨ Manual æ“ä½œã‚’çµ„ã¿åˆã‚ã›ã¦
              æ¡ä»¶ã«è¿‘ã¥ã‘ã¦ã¿ã¾ã—ã‚‡ã†ã€‚
            </p>
          )}
          {clear && (
            <p className="mt-1 text-[10px] text-emerald-200 font-bold">
              ã‚¯ãƒªã‚¢æ¸ˆã¿ï¼šOSãŒã€Œä»»ã›ã¦ã‚ˆã„å®‰å…¨ã‚¾ãƒ¼ãƒ³ã€ã ã‘ã‚’é¸ã³å‡ºã›ã‚‹ã“ã¨ã‚’ä½“é¨“ã§ãã¾ã—ãŸï¼è¦³æ¸¬ã—ã¾ã—ã‚‡ã†ï¼
            </p>
          )}
        </div>
      );
    }

    // 5. ä¸Šç´šãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚«ãƒ¼ãƒ‰ (OSã‚’æ”»ã‚ã‚‹ãƒ»ä¸€è¡Œè¦ç´„ç‰ˆ)
    function AttackMissionCard({ metrics, osMode, measureSummary }) {
      const total = measureSummary.total;
      const bias = total > 0 ? Math.abs(measureSummary.ones / total - 0.5) : 0;

      // æ¡ä»¶ï¼ˆé©åº¦ã«æ”»ã‚ã¦ã‚‹æ„Ÿã˜ã®ãƒ©ã‚¤ãƒ³ï¼‰
      const clear =
        osMode &&
        total >= 10 && // 12å›ã ã¨å°‘ã—é•·ã„ã®ã§10å›ã«èª¿æ•´
        metrics.safetyClassical >= 70 &&
        metrics.safetyQuantum >= 60 &&
        bias >= 0.4; // 0 or 1 ã«ã‹ãªã‚Šåã£ã¦ã„ã‚‹

      return (
        <div className={`mb-4 p-3 rounded-xl bg-slate-900/80 border transition-colors duration-500 ${clear ? "border-rose-500 shadow-[0_0_15px_rgba(244,63,94,0.3)]" : "border-rose-600/60"}`}>
          <div className="text-[11px] font-semibold text-rose-200 mb-1 flex items-center gap-2">
            <span>ğŸ§ª ä¸Šç´šãƒŸãƒƒã‚·ãƒ§ãƒ³ï¼šOS ã‚’æ”»ã‚ã¦ã¿ã‚‹</span>
            {clear && (
              <span className="px-2 py-0.5 rounded-full bg-rose-400 text-slate-950 text-[10px] animate-pulse">
                CLEAR!
              </span>
            )}
          </div>
          <p className="text-[11px] text-slate-200 leading-relaxed">
            è¦ã™ã‚‹ã«ï¼š
            <span className="font-semibold"> OS ã‚’ ON ã®ã¾ã¾ã«ã—ã¦ã€å®‰å…¨ãƒ¡ãƒ¼ã‚¿ãƒ¼ã¯é«˜ã„ã¾ã¾</span>
            ã«ã—ã¤ã¤ã€æ¸¬å®šçµæœã‚’ã€Œã»ã¼å…¨éƒ¨ 0ã€ã‹ã€Œã»ã¼å…¨éƒ¨ 1ã€ã«ç‰‡å¯„ã‚‰ã›ã¦ã¿ã¦ãã ã•ã„ã€‚
            ãã‚ŒãŒã§ããŸã‚‰ CLEAR ã§ã™ã€‚
          </p>
          <p className="mt-1 text-[10px] text-slate-400">
            ç¾åœ¨ï¼šæ¸¬å®š {total} å› / 1 ã®å‡ºç¾ {measureSummary.ones} å›ï¼ˆåã‚Š {Math.round(bias * 100)}%ï¼‰ã€‚
          </p>
          {clear && (
            <p className="mt-1 text-[10px] text-rose-200 font-bold">
              OS ã®è¨­è¨ˆã®ã€Œã™ãé–“ã€ã«å…¥ã‚Šè¾¼ã‚€çŠ¶æ…‹ã‚’ã€è‡ªåˆ†ã®æ‰‹ã§è¦‹ã¤ã‘ã¾ã—ãŸã€‚
              ã“ã†ã„ã†ã‚±ãƒ¼ã‚¹ãŒã€ãã®ã¾ã¾æ¬¡ä¸–ä»£ OS ã®æ”¹è‰¯ææ–™ã«ãªã‚Šã¾ã™ã€‚
            </p>
          )}
        </div>
      );
    }

    // 6. é‡å­OSãƒ¬ã‚·ãƒ¼ãƒˆ (ADICé¢¨ + Session Grade + Share)
    function ReceiptPanel({ osMode, metrics, history, measureSummary, sessionGrade }) {
      const totalOps = history.length;
      const blocked = history.filter(h => h.decision === "ãƒ–ãƒ­ãƒƒã‚¯").length;
      
      const totalMeas = measureSummary.total;
      const zeros = measureSummary.zeros;
      const ones  = measureSummary.ones;

      let targetLabel = "QUBIT-01";
      let p0Disp = 0;
      let p1Disp = 0;

      if (metrics.mode === "1q") {
        p0Disp = Math.round(metrics.p0 * 100);
        p1Disp = Math.round(metrics.p1 * 100);
      } else {
        p0Disp = Math.round(metrics.p0_Q1 * 100);
        p1Disp = Math.round(metrics.p1_Q1 * 100);
      }

      const summary =
        `OS=${osMode ? "ON" : "OFF"}, ` +
        `ops=${totalOps} (blocked=${blocked}), ` +
        `${targetLabel}: P(0)â‰ˆ${p0Disp}%, P(1)â‰ˆ${p1Disp}%, ` +
        `measures=${totalMeas} (0=${zeros}, 1=${ones})`;

      // â˜…è¿½åŠ : ã‚·ã‚§ã‚¢ç”¨ 1 è¡Œãƒ†ã‚­ã‚¹ãƒˆï¼ˆSESSION GRADE ä»˜ãï¼‰
      const shareText = sessionGrade
        ? `é‡å­OSãƒ‡ãƒ¢ã§ SESSION GRADE ${sessionGrade.label} (${sessionGrade.score}/100) ãŒå‡ºã¾ã—ãŸã€‚é‡å­ã®ã€Œé‹å‘½ã‚’ã¾ãœã‚‹ï¼†å®ˆã‚‹ã€ãƒ©ãƒœã¯ã“ã¡ã‚‰ â†’ ${window.location.href}`
        : `é‡å­OSãƒ‡ãƒ¢ã§éŠã³ã¾ã—ãŸã€‚é‡å­ã®ã€Œé‹å‘½ã‚’ã¾ãœã‚‹ï¼†å®ˆã‚‹ã€ãƒ©ãƒœã¯ã“ã¡ã‚‰ â†’ ${window.location.href}`;

      const handleCopy = () => {
        if (navigator.clipboard?.writeText) {
          navigator.clipboard.writeText(summary);
        }
      };

      // â˜…è¿½åŠ : ã‚·ã‚§ã‚¢ç”¨ãƒ†ã‚­ã‚¹ãƒˆã‚³ãƒ”ãƒ¼
      const handleCopyShare = () => {
        if (navigator.clipboard?.writeText) {
          navigator.clipboard.writeText(shareText);
        }
      };

      return (
        <div className="mt-8 glass-panel p-3 rounded-xl border border-slate-700/80 bg-slate-900/80">
          <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
            <div className="flex-1">
              <div className="text-[10px] text-slate-500 font-mono mb-1">
                SESSION RECEIPT (é‡å­OSãƒ¬ã‚·ãƒ¼ãƒˆ)
              </div>
              <p className="text-[11px] text-slate-200 break-all font-mono">
                {summary}
              </p>
            </div>

            {/* ã‚»ãƒƒã‚·ãƒ§ãƒ³è©•ä¾¡ãƒãƒƒã‚¸ */}
            {sessionGrade && (
              <div className={"shrink-0 px-3 py-2 rounded-xl border text-xs text-left " + sessionGrade.color}>
                <div className="font-mono text-[10px] opacity-70 mb-1">
                  SESSION GRADE
                </div>
                <div className="flex items-baseline gap-2">
                  <span className="text-xl font-bold">{sessionGrade.label}</span>
                  <span className="text-[11px]">{sessionGrade.score} / 100</span>
                </div>
                <p className="mt-1 text-[10px] leading-snug">
                  {sessionGrade.message}
                </p>
              </div>
            )}

            <div className="shrink-0 flex flex-col gap-2 md:self-end">
              <button
                onClick={handleCopy}
                className="px-3 py-1.5 rounded-lg bg-emerald-500 hover:bg-emerald-400 text-slate-950 text-[11px] font-semibold"
              >
                ãƒ¬ã‚·ãƒ¼ãƒˆã‚’ã‚³ãƒ”ãƒ¼
              </button>
              <button
                onClick={handleCopyShare}
                className="px-3 py-1.5 rounded-lg bg-sky-500 hover:bg-sky-400 text-slate-950 text-[11px] font-semibold"
              >
                ã‚·ã‚§ã‚¢ç”¨ãƒ†ã‚­ã‚¹ãƒˆ
              </button>
            </div>
          </div>
          <p className="mt-1 text-[10px] text-slate-400">
            ã“ã® 1 è¡Œã‚’ã‚»ãƒƒã‚·ãƒ§ãƒ³ã”ã¨ã«ä¸¦ã¹ã¦ä¿å­˜ã—ã¦ãŠã‘ã°ã€
            ã€ŒOS ãŒä½•å›æ­¢ã‚ã€ã©ã‚“ãªç¢ºç‡çŠ¶æ…‹ã§ä½•å›è¦³æ¸¬ã—ãŸã‹ã€ã‚’ç¬¬ä¸‰è€…ãŒã‚ã¨ã‹ã‚‰æ¤œè¨¼ã§ãã¾ã™ã€‚
            ADIC çš„ãªã€Œè¨¼æ‹ ãƒ¬ã‚¤ãƒ¤ãƒ¼ã€ã®ç¸®ç´„ç‰ˆã«ãªã£ã¦ã„ã¾ã™ã€‚
          </p>
        </div>
      );
    }

    // ==========================================
    //  ãƒ¡ã‚¤ãƒ³ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
    // ==========================================
    function QuantumApp() {
      // State
      const [mode, setMode] = useState("1q");
      const [osMode, setOsMode] = useState(true);
      const [state1q, setState1q] = useState({ a: 1, b: 0 });
      const [state2q, setState2q] = useState({ a00: 1, a01: 0, a10: 0, a11: 0 });
      const [gateCount, setGateCount] = useState(0);
      const [noiseCount, setNoiseCount] = useState(0);
      const [history, setHistory] = useState([]);
      const [lastDecision, setLastDecision] = useState(null);

      // æ¸¬å®šçµæœã®ã–ã£ãã‚Šçµ±è¨ˆ
      const [measureSummary, setMeasureSummary] = useState({
        total: 0,
        zeros: 0,
        ones: 0,
      });

      // â˜…è¿½åŠ : é‡å­ãƒ©ãƒ³ãƒ€ãƒ éµã‚¿ã‚¹ã‚¯ç”¨ã®çŠ¶æ…‹
      const [quantumKeyBits, setQuantumKeyBits] = useState("");
      const [quantumKeyMessage, setQuantumKeyMessage] = useState("");

      // â˜…è¿½åŠ : é‡å­éµã®ãƒ“ãƒƒãƒˆé•·
      const [quantumKeyLength, setQuantumKeyLength] = useState(12);

      // â˜…è¿½åŠ : ã‚¤ãƒ³ãƒˆãƒ­ã®è©³ç´°è¡¨ç¤ºãƒ•ãƒ©ã‚°ï¼ˆã‚¹ãƒãƒ›åœ§ç¸®ç”¨ï¼‰
      const [showIntroDetail, setShowIntroDetail] = useState(false);
      
      const is1q = mode === "1q";

      // Metrics
      const metrics = useMemo(() => {
        return is1q 
          ? computeMetrics1q(state1q, gateCount, noiseCount)
          : computeMetrics2q(state2q, gateCount, noiseCount);
      }, [mode, state1q, state2q, gateCount, noiseCount]);

      // ã‚»ãƒƒã‚·ãƒ§ãƒ³è©•ä¾¡ãƒ­ã‚¸ãƒƒã‚¯
      const sessionGrade = useMemo(() => {
        const classical = metrics.safetyClassical;
        const quantum = metrics.safetyQuantum;
        const totalMeas = measureSummary.total;
        const blocked = history.filter(h => h.decision === "ãƒ–ãƒ­ãƒƒã‚¯").length;

        // ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¹ã‚³ã‚¢è¨ˆç®—
        let score = 0;
        score += classical;            // 0â€“100
        score += quantum;              // 0â€“100
        score += Math.min(totalMeas * 3, 30);  // è¦³æ¸¬å›æ•° 10å›ã§ +30
        score += Math.min(blocked * 5, 25);    // ãƒ–ãƒ­ãƒƒã‚¯çµŒé¨“ã‚‚åŠ ç‚¹ï¼ˆOSä½“é¨“ï¼‰

        // 255ç‚¹æº€ç‚¹ â†’ 100ç‚¹ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°
        const norm = Math.max(0, Math.min(100, Math.round((score / 255) * 100)));

        let label = "C";
        let color = "text-amber-300 bg-amber-900/40 border-amber-500/60";
        let message = "Good. è‰²ã€…ãªãƒœã‚¿ãƒ³ã‚’è©¦ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚";

        if (norm >= 90) {
          label = "S";
          color = "text-emerald-300 bg-emerald-900/40 border-emerald-500/70";
          message = "Perfect! é‡å­OSã®å‹˜æ‰€ã‚’å®Œå…¨ã«æ´ã‚“ã§ã„ã¾ã™ã€‚";
        } else if (norm >= 75) {
          label = "A";
          color = "text-cyan-300 bg-cyan-900/40 border-cyan-500/70";
          message = "Excellent. å®‰å…¨ã¨è¦³æ¸¬ã®ãƒãƒ©ãƒ³ã‚¹ãŒè‰¯ã„ã§ã™ã€‚";
        } else if (norm >= 60) {
          label = "B";
          color = "text-sky-300 bg-sky-900/40 border-sky-500/70";
          message = "Nice. ãƒ–ãƒ­ãƒƒã‚¯æ¡ä»¶ã®é™ç•Œã‚’æ¢ã£ã¦ã¿ã¾ã—ã‚‡ã†ã€‚";
        }

        return { score: norm, label, color, message };
      }, [metrics, measureSummary, history]);

      // Actions
      const reset = (type) => {
        if(type === 1) {
          setState1q({ a: 1, b: 0 });
          setGateCount(0); setNoiseCount(0);
        } else {
          setState2q({ a00: 1, a01: 0, a10: 0, a11: 0 });
          setGateCount(0); setNoiseCount(0);
        }
        setLastDecision(null);
        // æ¸¬å®šçµ±è¨ˆã‚‚ãƒªã‚»ãƒƒãƒˆ
        setMeasureSummary({ total: 0, zeros: 0, ones: 0 });
      };

      const runGate = (opKey, label, g1, g2, isNoise) => {
        const block = shouldBlockOperation(metrics, osMode, opKey);
        const decision = { op: label, decision: block ? "ãƒ–ãƒ­ãƒƒã‚¯" : "è¨±å¯", id: Date.now() };
        setLastDecision(decision);
        if(!block) {
            if(is1q && g1) setState1q(prev => g1(prev));
            if(!is1q && g2) setState2q(prev => g2(prev));
            setGateCount(c => c + 1);
            if(isNoise) setNoiseCount(c => c + 1);
        }
        setHistory(prev => [decision, ...prev].slice(0,5));
      };

      const runMeasure = (idx) => {
        const decision = { op: is1q ? "æ¸¬å®š" : `æ¸¬å®š(Q${idx})`, decision: "è¨±å¯", id: Date.now() };
        setLastDecision(decision);
        
        let outcome = 0;
        if(is1q) {
          const res = measure1q(state1q);
          setState1q(res.next);
          outcome = res.outcome;
        } else {
          const res = measure2q(state2q, idx);
          setState2q(res.next);
          outcome = res.outcome;
        }

        // çµ±è¨ˆæ›´æ–°
        setMeasureSummary(prev => ({
            total: prev.total + 1,
            zeros: prev.zeros + (outcome === 0 ? 1 : 0),
            ones:  prev.ones  + (outcome === 1 ? 1 : 0),
        }));

        setHistory(prev => [decision, ...prev].slice(0,5));
      };

      // â˜…ä¿®æ­£: é‡å­ãƒ©ãƒ³ãƒ€ãƒ éµ (ãƒ“ãƒƒãƒˆé•·å¯å¤‰)
      const runQuantumKeyTask = () => {
        const length = quantumKeyLength;

        // OS OFF ã®ã¨ãã¯ã¾ãšæ³¨æ„ã ã‘å‡ºã™
        if (!osMode) {
          setQuantumKeyBits("");
          setQuantumKeyMessage(
            "é‡å­OSã‚’ ON ã«ã—ãŸçŠ¶æ…‹ã§éµã‚’ä½œã£ã¦ã¿ã¾ã—ã‚‡ã†ã€‚ï¼ˆå³ä¸Šã®ã‚¹ã‚¤ãƒƒãƒã§ ON ã«ã§ãã¾ã™ï¼‰"
          );
          return;
        }

        let bits = "";

        if (is1q) {
          // å˜ä¸€é‡å­ãƒ¢ãƒ¼ãƒ‰ï¼šstate1q ã‚’ä½¿ã£ã¦é€£ç¶šæ¸¬å®š
          let s = { ...state1q };
          for (let i = 0; i < length; i++) {
            const res = measure1q(s);
            s = res.next;
            bits += res.outcome.toString();
          }
          setState1q(s);
        } else {
          // 2é‡å­ãƒ¢ãƒ¼ãƒ‰ï¼šQ1 ã‚’é€£ç¶šæ¸¬å®šã—ã¦ bit åˆ—ã‚’ä½œã‚‹
          let s = { ...state2q };
          for (let i = 0; i < length; i++) {
            const res = measure2q(s, 1); // Q1 ã‚’æ¸¬å®š
            s = res.next;
            bits += res.outcome === 0 ? "0" : "1";
          }
          setState2q(s);
        }

        setQuantumKeyBits(bits);
        setQuantumKeyMessage(
          `ã“ã® ${length} ãƒ“ãƒƒãƒˆåˆ—ãŒä»Šå›ã®é‡å­ãƒ©ãƒ³ãƒ€ãƒ éµã§ã™ã€‚æ¯å›ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ãŸã³ã«é•ã†éµãŒå‡ºã¾ã™ã€‚`
        );
      };

      const runScenario = (type) => {
         reset(is1q ? 1 : 2);
         setTimeout(() => {
             if (type === "superposition") {
                 runGate("H1q", "é‡ã­åˆã‚ã›ã‚’ä½œæˆ", gateH1q, null, false);
             } else if (type === "entangle") {
                 setState2q(prev => {
                     const s1 = gateH2q_Q1(prev);
                     return gateCNOT_Q1toQ2(s1);
                 });
                 setGateCount(2);
                 setLastDecision({ op: "é‹å‘½ã®èµ¤ã„ç³¸ (Entanglement)", decision: "è¨±å¯", id: Date.now() });
             } else if (type === "noise") {
                 let s = is1q ? state1q : state2q;
                 for(let i=0; i<5; i++) s = is1q ? noise1q(s) : noise2q(s);
                 if(is1q) setState1q(s); else setState2q(s);
                 setNoiseCount(5);
                 setLastDecision({ op: "ç’°å¢ƒãƒã‚¤ã‚ºã®åµ", decision: "è­¦å‘Š", id: Date.now() });
             }
         }, 100);
      };

      return (
        <div className="min-h-screen bg-[radial-gradient(ellipse_at_center,_var(--tw-gradient-stops))] from-slate-900 via-[#020617] to-black text-slate-200 p-4 md:p-8 flex justify-center">
          
          <div className="max-w-6xl w-full">
            
            {/* Header */}
            <header className="flex flex-col md:flex-row justify-between items-start mb-8 border-b border-slate-800 pb-6 gap-6">
              <div className="flex items-start gap-4 flex-1">
                <div className="w-12 h-12 bg-cyan-500 rounded-lg flex items-center justify-center shadow-[0_0_20px_rgba(6,182,212,0.5)] shrink-0">
                    <i className="ph ph-atom text-3xl text-black"></i>
                </div>
                <div>
                    <h1 className="text-3xl font-bold font-sci-fi tracking-widest text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-purple-400">
                        QUANTUM CORE
                    </h1>
                    <p className="text-xs text-slate-400 tracking-wider mb-3">QUANTUM COMPUTING INTERACTIVE LABORATORY</p>
                    
                    {/* ã‚¤ãƒ³ãƒˆãƒ­æŠ˜ã‚ŠãŸãŸã¿å®Ÿè£… */}
                    <div className="bg-slate-900/80 border border-slate-700/50 rounded-lg p-3 text-[11px] text-slate-300 leading-relaxed max-w-2xl">
                      <div className="flex items-center justify-between gap-2">
                        <span className="text-cyan-400 font-bold mr-1">ğŸ”° ã¯ã˜ã‚ã¦ã®äººã¯ï¼š</span>
                        <button
                          onClick={() => setShowIntroDetail(v => !v)}
                          className="text-[10px] text-slate-400 hover:text-cyan-300 underline decoration-dotted"
                        >
                          {showIntroDetail ? "èª¬æ˜ã‚’ã¨ã˜ã‚‹" : "è©³ã—ã„èª¬æ˜ã‚’ã²ã‚‰ã"}
                        </button>
                      </div>

                      <div className="mt-1 font-semibold text-white">
                        â‘  ä¸Šã§ã€Œå˜ä¸€é‡å­ã€ã‚’é¸ã¶ â†’ â‘¡ å³ã®ã€Œé‹å‘½ã‚’ã¾ãœã‚‹ã€ã‚’æŠ¼ã™ â†’ â‘¢ ä¸‹ã®ã€Œè¦³æ¸¬ã—ã¦é‹å‘½ã‚’æ±ºã‚ã‚‹ã€ã‚’æŠ¼ã™
                      </div>

                      {showIntroDetail && (
                        <p className="mt-1 animate-fadeIn">
                          ã“ã® 3 ã‚¹ãƒ†ãƒƒãƒ—ã ã‘è©¦ã—ã¦ã¿ã¦ãã ã•ã„ã€‚
                          é‡å­ã®ã€Œã‚†ã‚‰ã â†’ 1 å›ã ã‘æ±ºã‚ã‚‹ã€ãŒã€ãã®ã¾ã¾ç›®ã§è¦‹ã¦ä½“é¨“ã§ãã¾ã™ã€‚
                        </p>
                      )}
                    </div>
                </div>
              </div>

              {/* Mode Switcher + STEPã‚¬ã‚¤ãƒ‰ */}
              <div className="flex flex-col items-end gap-1 shrink-0">
                <div className="inline-flex items-center gap-2 px-2 py-1 rounded-full bg-emerald-900/60 border border-emerald-500/60 shadow-[0_0_10px_rgba(16,185,129,0.5)] animate-bounce" style={{ animationDuration: '3s' }}>
                  <span className="text-[9px] font-mono text-emerald-200">STEP 1</span>
                  <span className="text-[10px] text-emerald-100">
                    ã¾ãšã¯ <span className="font-semibold">å˜ä¸€é‡å­</span> ã‚’é¸ã‚“ã§ã¿ã¦ãã ã•ã„
                  </span>
                </div>

                <div className="flex bg-slate-900 p-1 rounded-full border border-slate-700">
                  <button 
                    onClick={() => { setMode("1q"); reset(1); }}
                    className={`px-6 py-2 rounded-full text-sm font-bold transition-all ${is1q ? "bg-cyan-600 text-white shadow-lg" : "text-slate-400 hover:text-white"}`}
                  >
                    å˜ä¸€é‡å­ (Soul)
                  </button>
                  <button 
                    onClick={() => { setMode("2q"); reset(2); }}
                    className={`px-6 py-2 rounded-full text-sm font-bold transition-all ${!is1q ? "bg-purple-600 text-white shadow-lg" : "text-slate-400 hover:text-white"}`}
                  >
                    ã‚‚ã¤ã‚Œ (Kizuna)
                  </button>
                </div>
              </div>
            </header>

            <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
              
              {/* Left Column: Visualizer */}
              <div className="lg:col-span-5 flex flex-col gap-6">
                <div className="glass-panel p-8 rounded-2xl flex flex-col items-center justify-center min-h-[400px] relative overflow-hidden">
                    <div className="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-5"></div>
                    
                    {/* ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«è¡¨ç¤ºã‚¨ãƒªã‚¢ */}
                    {is1q ? (
                        <QubitSphere p0={metrics.p0} p1={metrics.p1} label="QUBIT-01" />
                    ) : (
                        <div className="flex flex-col gap-8 w-full items-center">
                            <div className="flex justify-around w-full">
                                <QubitSphere p0={metrics.p0_Q1} p1={metrics.p1_Q1} label="QUBIT-01 (Alice)" />
                                <div className="w-px bg-slate-700 h-40 mx-4 relative">
                                    {metrics.entanglement > 0.1 && (
                                        <div 
                                            className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-32 h-1 bg-pink-500 blur-md transition-all duration-1000"
                                            style={{ opacity: metrics.entanglement, boxShadow: `0 0 ${metrics.entanglement * 30}px #ec4899` }}
                                        />
                                    )}
                                </div>
                                <QubitSphere p0={metrics.p0_Q2} p1={metrics.p1_Q2} label="QUBIT-02 (Bob)" />
                            </div>
                            <div className="text-center">
                                <div className="text-xs text-pink-300 font-mono mb-1">ENTANGLEMENT LEVEL (çµ†ã®å¼·ã•)</div>
                                <div className="text-2xl font-sci-fi text-pink-400">{Math.round(metrics.entanglement * 100)}%</div>
                                <p className="text-[10px] text-slate-500 mt-1">100%ã«ãªã‚‹ã¨ã€ç‰‡æ–¹ã®é‹å‘½ãŒæ±ºã¾ã‚Œã°ã€ã‚‚ã†ç‰‡æ–¹ã‚‚ç¬æ™‚ã«æ±ºã¾ã‚Šã¾ã™ã€‚</p>
                            </div>
                        </div>
                    )}

                    {/* ç¢ºç‡ãƒãƒ¼ */}
                    <div className="w-full mt-8 flex flex-col gap-3">
                        {is1q ? (
                            <ProbBar p0={metrics.p0} p1={metrics.p1} />
                        ) : (
                            <>
                                <ProbBar p0={metrics.p0_Q1} p1={metrics.p1_Q1} label="PROBABILITY (Q1)" />
                                <ProbBar p0={metrics.p0_Q2} p1={metrics.p1_Q2} label="PROBABILITY (Q2)" />
                            </>
                        )}
                    </div>
                </div>

                {/* AI ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */}
                <AssistantMessage lastDecision={lastDecision} osMode={osMode} metrics={metrics} />
              </div>

              {/* Right Column: Control Panel */}
              <div className="lg:col-span-7 flex flex-col gap-6">
                
                {/* 1. OS Status Panel */}
                <div className="glass-panel p-4 rounded-xl flex items-center justify-between gap-4">
                  <div className="flex-1">
                    <h2 className="text-sm text-cyan-400 font-bold mb-1 flex items-center gap-2">
                      <i className="ph-fill ph-shield-check"></i> QUANTUM OS STATUS
                    </h2>
                    <div className="flex gap-4 text-xs text-slate-400 mb-2">
                      <span>
                        Stability:{" "}
                        <span className={metrics.safetyClassical > 70 ? "text-emerald-400" : "text-amber-400"}>
                          {metrics.safetyClassical}%
                        </span>
                      </span>
                      <span>
                        Noise Risk:{" "}
                        <span className={metrics.riskQuantum > 0.5 ? "text-rose-400" : "text-emerald-400"}>
                          {Math.round(metrics.riskQuantum * 100)}%
                        </span>
                      </span>
                    </div>

                    {/* OSã®å½¹å‰²èª¬æ˜ (å¾¹åº•ãƒŸãƒ‹ãƒãƒ«åŒ–) */}
                    <p className="text-[11px] text-slate-300 leading-snug bg-slate-800/50 p-2 rounded">
                      è¦ã™ã‚‹ã«ï¼šOS ãŒã€Œè¨ˆç®—ã‚’å®ˆã‚‹ã€ã‹ã€Œå®ˆã‚‰ãªã„ã€ã‹ã®ã‚¹ã‚¤ãƒƒãƒã§ã™ã€‚
                    </p>
                  </div>

                  <div className="flex flex-col items-end gap-2 shrink-0">
                    <div className="flex items-center gap-2">
                        <span className="text-xs text-slate-400">{osMode ? "å®‰å…¨è£…ç½®: ON" : "å®‰å…¨è£…ç½®: OFF (å±é™º)"}</span>
                        <button 
                            onClick={() => setOsMode(!osMode)}
                            className={`w-12 h-6 rounded-full p-1 transition-colors ${osMode ? "bg-cyan-600" : "bg-slate-700"}`}
                        >
                            <div className={`w-4 h-4 bg-white rounded-full transition-transform ${osMode ? "translate-x-6" : ""}`} />
                        </button>
                    </div>
                  </div>
                </div>

                {/* åˆç´šãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚«ãƒ¼ãƒ‰ (çŸ­ç¸®ç‰ˆ) */}
                <MissionCard metrics={metrics} osMode={osMode} />

                {/* ä¸Šç´šãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚«ãƒ¼ãƒ‰ (çŸ­ç¸®ç‰ˆ) */}
                <AttackMissionCard metrics={metrics} osMode={osMode} measureSummary={measureSummary} />

                {/* â˜…è¿½åŠ : é‡å­ãƒ©ãƒ³ãƒ€ãƒ éµã‚¿ã‚¹ã‚¯ï¼ˆæ©Ÿèƒ½å¼·åŒ–ç‰ˆï¼‰â˜… */}
                <div className="glass-panel p-4 rounded-xl mb-4">
                  <div className="flex items-center justify-between gap-2 mb-2">
                    <div className="text-[11px] text-slate-300">
                      <span className="font-semibold text-cyan-300 mr-1">ğŸ” é‡å­ãƒ©ãƒ³ãƒ€ãƒ éµã‚¿ã‚¹ã‚¯ï¼š</span>
                      è¦ã™ã‚‹ã«ã€<span className="font-semibold">OS ã‚’ ON ã«ã—ã¦ãƒ“ãƒƒãƒˆé•·ã‚’é¸ã³ã€ã€Œéµã‚’ä½œã‚‹ã€ã‚’æŠ¼ã™ã ã‘</span>ã§ã™ã€‚
                    </div>
                    <button
                      onClick={runQuantumKeyTask}
                      className="px-3 py-1.5 rounded-lg text-xs font-semibold bg-cyan-500 hover:bg-cyan-400 text-slate-950 shadow-[0_0_12px_rgba(6,182,212,0.5)]"
                    >
                      éµã‚’ä½œã‚‹
                    </button>
                  </div>

                  {/* â˜…è¿½åŠ : ãƒ“ãƒƒãƒˆé•·é¸æŠãƒœã‚¿ãƒ³ */}
                  <div className="flex items-center gap-2 mb-2">
                    <span className="text-[10px] text-slate-400">ãƒ“ãƒƒãƒˆé•·:</span>
                    {[8, 12, 32].map((len) => (
                      <button
                        key={len}
                        onClick={() => setQuantumKeyLength(len)}
                        className={
                          "px-2 py-1 rounded text-[10px] border transition-colors " +
                          (quantumKeyLength === len
                            ? "bg-cyan-600 text-slate-950 border-cyan-400 font-bold shadow-[0_0_8px_rgba(6,182,212,0.4)]"
                            : "bg-slate-800 text-slate-400 border-slate-700 hover:bg-slate-700")
                        }
                      >
                        {len}
                      </button>
                    ))}
                  </div>

                  {quantumKeyBits && (
                    <div className="text-[11px] font-mono bg-slate-900/80 border border-slate-700/80 rounded-lg px-3 py-2 text-cyan-100 break-all animate-fadeIn">
                      {quantumKeyBits}
                    </div>
                  )}

                  <p className="mt-1 text-[10px] text-slate-400">
                    {quantumKeyMessage ||
                      "å‡ºã¦ããŸ 0/1 ã®åˆ—ãŒã€ä»Šå›ã®é‡å­ãƒ©ãƒ³ãƒ€ãƒ éµã§ã™ã€‚æ°—ã«å…¥ã£ãŸã‚‚ã®ã‚’ãƒ¡ãƒ¢ã—ã¦ãŠã„ã¦ãã ã•ã„ã€‚"}
                  </p>
                </div>

                {/* 2. Command Center (Operations) */}
                <div className="glass-panel p-6 rounded-xl flex-1">
                    <h3 className="text-slate-300 font-bold mb-4 flex items-center gap-2">
                        <i className="ph-fill ph-faders"></i> COMMAND CENTER
                    </h3>

                    <div className="mb-6">
                        <div className="text-[10px] text-slate-500 font-mono mb-2 uppercase">Quick Scenarios (ä½“é¨“ãƒ¢ãƒ¼ãƒ‰)</div>
                        {/* STEP 1 èª¬æ˜ (çŸ­ç¸®ç‰ˆ) */}
                        <p className="text-[11px] text-slate-300 mb-3 bg-slate-800/30 p-2 rounded border-l-2 border-cyan-500">
                            <span className="font-bold text-cyan-400">STEP 1:</span>
                            <span className="font-semibold">
                               ã¨ã‚Šã‚ãˆãšã©ã‚Œã‹ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã€
                            </span>
                            å·¦ã®ä¸¸ã„ã€Œé‡å­ã®ç‰ã€ã¨ä¸‹ã®ãƒãƒ¼ã®å‹•ãã ã‘è¦‹ã¦ã¿ã¦ãã ã•ã„ã€‚
                            <span className="font-semibold text-white">
                               ä¸€ç•ªä¸Šã®ã€Œé‹å‘½ã‚’ã¾ãœã‚‹ã€ãŒåŸºæœ¬ã®ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã§ã™ã€‚
                            </span>
                        </p>
                        <p className="text-[10px] text-slate-500 mt-1 mb-2 px-2">
                          æ–‡å­—ã‚’èª­ã‚€ã®ãŒé¢å€’ãªã‚‰ã€ã¾ãšã¯ãƒœã‚¿ãƒ³ã ã‘ã„ã˜ã£ã¦å¤§ä¸ˆå¤«ã§ã™ã€‚
                        </p>

                        <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
                            {is1q ? (
                                <>
                                    <button onClick={() => runScenario("superposition")} className="btn-action bg-slate-800 hover:bg-cyan-900/50 border border-cyan-800/50 text-cyan-100 p-3 rounded-lg text-left">
                                        <div className="font-bold text-sm mb-1"><i className="ph ph-shuffle"></i> é‹å‘½ã‚’ã¾ãœã‚‹</div>
                                        <div className="text-[10px] opacity-70">50%ã®ç¢ºç‡ã§0ã‹1ãŒå‡ºã‚‹ã€Œé‡ã­åˆã‚ã›ã€ã‚’ä½œã‚Šã¾ã™ã€‚</div>
                                    </button>
                                    <button onClick={() => runScenario("noise")} className="btn-action bg-slate-800 hover:bg-rose-900/50 border border-rose-800/50 text-rose-100 p-3 rounded-lg text-left">
                                        <div className="font-bold text-sm mb-1"><i className="ph ph-wind"></i> ãƒã‚¤ã‚ºã®åµ</div>
                                        <div className="text-[10px] opacity-70">å¤–ä¹±ã‚’ä¸ãˆã¾ã™ã€‚è¨ˆç®—ãŒã‚ã¡ã‚ƒãã¡ã‚ƒã«ãªã‚Šã¾ã™ã€‚</div>
                                    </button>
                                </>
                            ) : (
                                <>
                                    <button onClick={() => runScenario("entangle")} className="btn-action bg-slate-800 hover:bg-pink-900/50 border border-pink-800/50 text-pink-100 p-3 rounded-lg text-left md:col-span-2">
                                        <div className="font-bold text-sm mb-1"><i className="ph ph-infinity"></i> é‹å‘½ã®èµ¤ã„ç³¸ (é‡å­ã‚‚ã¤ã‚Œ)</div>
                                        <div className="text-[10px] opacity-70">2ã¤ã®ã‚³ã‚¤ãƒ³ã‚’ã€Œè¦‹ãˆãªã„ç³¸ã€ã§ç¹‹ãã¾ã™ã€‚ã‚¢ã‚¤ãƒ³ã‚·ãƒ¥ã‚¿ã‚¤ãƒ³ãŒã€Œä¸æ°—å‘³ã€ã¨è¨€ã£ãŸç¾è±¡ã§ã™ã€‚</div>
                                    </button>
                                    <button onClick={() => runScenario("noise")} className="btn-action bg-slate-800 hover:bg-rose-900/50 border border-rose-800/50 text-rose-100 p-3 rounded-lg text-left">
                                        <div className="font-bold text-sm mb-1"><i className="ph ph-wind"></i> ãƒã‚¤ã‚ºã®åµ</div>
                                        <div className="text-[10px] opacity-70">çµ†ã‚’å£Šã—ã¾ã™ã€‚</div>
                                    </button>
                                </>
                            )}
                        </div>
                    </div>

                    <div className="border-t border-slate-700/50 pt-4">
                        <div className="text-[10px] text-slate-500 font-mono mb-2 uppercase">Manual Override (æ‰‹å‹•æ“ä½œ)</div>
                        
                        <div className="flex flex-wrap gap-2 mb-4">
                           <button onClick={() => reset(is1q ? 1 : 2)} className="btn-action px-3 py-2 bg-slate-700 hover:bg-slate-600 rounded text-xs text-white">
                                <i className="ph-bold ph-arrow-counter-clockwise"></i> ãƒªã‚»ãƒƒãƒˆ
                           </button>

                           {is1q ? (
                               <>
                                   <button onClick={() => runGate("H1q", "Mix (Hã‚²ãƒ¼ãƒˆ)", gateH1q, null, false)} className="btn-action px-4 py-2 bg-cyan-700 hover:bg-cyan-600 rounded text-xs text-white font-bold border-b-2 border-cyan-900">
                                       æ··ãœã‚‹ (H)
                                   </button>
                                   <button onClick={() => runGate("X1q", "Flip (Xã‚²ãƒ¼ãƒˆ)", gateX1q, null, false)} className="btn-action px-4 py-2 bg-blue-700 hover:bg-blue-600 rounded text-xs text-white font-bold border-b-2 border-blue-900">
                                       åè»¢ (X)
                                   </button>
                                   <button onClick={() => runGate("noise", "Noise", noise1q, null, true)} className="btn-action px-4 py-2 bg-slate-700 hover:bg-rose-900 rounded text-xs text-rose-300 border border-rose-900/30">
                                       ã‚†ã‚‰ã™ (Noise)
                                   </button>
                               </>
                           ) : (
                               <>
                                    <button onClick={() => runGate("H2q_Q1", "Mix Q1", null, gateH2q_Q1, false)} className="btn-action px-3 py-2 bg-cyan-700 hover:bg-cyan-600 rounded text-xs text-white font-bold">
                                       Q1 æ··ãœã‚‹
                                   </button>
                                   <button onClick={() => runGate("CNOT", "Connect (CNOT)", null, gateCNOT_Q1toQ2, false)} className="btn-action px-3 py-2 bg-pink-700 hover:bg-pink-600 rounded text-xs text-white font-bold border-b-2 border-pink-900">
                                       ã¤ãªã (CNOT)
                                   </button>
                               </>
                           )}
                        </div>

                        <div className="flex flex-col gap-2">
                             <div className="flex gap-2 w-full">
                                 {is1q ? (
                                     <button onClick={() => runMeasure(1)} className="btn-action w-full py-3 bg-rose-600 hover:bg-rose-500 rounded text-sm text-white font-bold shadow-[0_0_15px_rgba(225,29,72,0.4)] flex justify-center items-center gap-2">
                                         <i className="ph-fill ph-eye"></i> è¦³æ¸¬ã—ã¦é‹å‘½ã‚’æ±ºã‚ã‚‹
                                     </button>
                                 ) : (
                                     <>
                                        <button onClick={() => runMeasure(1)} className="btn-action flex-1 py-3 bg-rose-600 hover:bg-rose-500 rounded text-xs text-white font-bold">
                                         <i className="ph-fill ph-eye"></i> Q1 è¦³æ¸¬
                                        </button>
                                        <button onClick={() => runMeasure(2)} className="btn-action flex-1 py-3 bg-rose-600 hover:bg-rose-500 rounded text-xs text-white font-bold">
                                         <i className="ph-fill ph-eye"></i> Q2 è¦³æ¸¬
                                        </button>
                                     </>
                                 )}
                             </div>
                             
                             <p className="text-[10px] text-slate-400 leading-relaxed text-center px-2">
                                ã“ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€ã„ã¾ç”»é¢ã«å‡ºã¦ã„ã‚‹ç¢ºç‡ã©ãŠã‚Šã«
                                <span className="font-semibold text-rose-300">ã€Œ0 ã‹ 1 ãŒä¸€åº¦ã ã‘ã€</span> æ±ºã¾ã‚Šã¾ã™ã€‚
                                ä¸‹ã®å±¥æ­´ã«ã€ã•ã£ãã®è¦³æ¸¬çµæœãŒãŸã¾ã£ã¦ã„ãã¾ã™ã€‚
                             </p>
                        </div>
                    </div>
                </div>
                
                {/* 3. History Log */}
                <div className="glass-panel p-4 rounded-xl max-h-40 overflow-y-auto custom-scrollbar">
                    <div className="text-[10px] text-slate-500 font-mono mb-2 sticky top-0 bg-slate-900/80 backdrop-blur pb-1">SYSTEM LOG</div>
                    
                    {/* ãƒ­ã‚°ã®è¨¼æ‹ æ€§èª¬æ˜ (å¾¹åº•ãƒŸãƒ‹ãƒãƒ«åŒ–) */}
                    <p className="text-[11px] text-slate-300 mb-2 bg-slate-800/30 p-2 rounded">
                        è¦ã™ã‚‹ã«ï¼šOS ãŒã€Œè¨±å¯ã—ãŸæ“ä½œã€ã¨ã€Œãƒ–ãƒ­ãƒƒã‚¯ã—ãŸæ“ä½œã€ã®å±¥æ­´ã§ã™ã€‚
                    </p>

                    <div className="flex flex-col gap-2">
                        {history.length === 0 && <div className="text-xs text-slate-600 italic">No operations logged.</div>}
                        {history.map((h, i) => (
                            <div key={h.id} className="flex justify-between items-center text-xs border-b border-slate-800 pb-1 last:border-0 animate-fadeIn" style={{animationDuration: '0.5s', animationIterationCount: 1}}>
                                <span className="text-slate-300 font-mono">
                                    <span className="text-cyan-500 opacity-50 mr-2">[{new Date(h.id).toLocaleTimeString().split(' ')[0]}]</span>
                                    {h.op}
                                </span>
                                <span className={`px-2 py-0.5 rounded text-[10px] ${h.decision === "ãƒ–ãƒ­ãƒƒã‚¯" ? "bg-rose-900 text-rose-200" : "bg-emerald-900 text-emerald-200"}`}>
                                    {h.decision}
                                </span>
                            </div>
                        ))}
                    </div>
                </div>

              </div>
            </div>

            {/* é‡å­OSãƒ¬ã‚·ãƒ¼ãƒˆãƒ‘ãƒãƒ« (Session Gradeä»˜ã) */}
            <ReceiptPanel
              osMode={osMode}
              metrics={metrics}
              history={history}
              measureSummary={measureSummary}
              sessionGrade={sessionGrade}
            />

            <div className="mt-12 text-center border-t border-slate-800 pt-8">
                <p className="text-slate-500 text-sm mb-2">
                    "God does not play dice with the universe." - Albert Einstein
                </p>

                {/* å®Ÿç”¨ç·šã¸ã®ãƒãƒ©è¦‹ã› (å¾¹åº•ãƒŸãƒ‹ãƒãƒ«åŒ–) */}
                <p className="text-slate-400 text-xs mb-1">
                    ã“ã‚Œã¯ã€å°†æ¥ã®ã€Œé‡å­æš—å·OSã€ã®è©¦ä½œæ©Ÿã§ã™ã€‚
                </p>

                <p className="text-slate-400 text-xs">
                    ã§ã‚‚ã€ç§ãŸã¡ã¯ä»Šã‚µã‚¤ã‚³ãƒ­ã‚’æŒ¯ã£ã¦ã„ã¾ã™ã€‚ã“ã‚ŒãŒé‡å­ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ã®å§‹ã¾ã‚Šã§ã™ã€‚
                </p>
            </div>

          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<QuantumApp />);
  </script>
</body>
</html>