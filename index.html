<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Quantum World Key Factory: Ultimate Edition</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React & ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <!-- Babel -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- Phosphor Icons -->
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@400;500;600;700&family=Zen+Kaku+Gothic+New:wght@400;700&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: 'Zen Kaku Gothic New', sans-serif;
      background-color: #020617;
      color: #e2e8f0;
      overflow-x: hidden;
      background-image: 
        radial-gradient(circle at 50% 0%, rgba(124, 58, 237, 0.1), transparent 40%),
        linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px);
      background-size: 100% 100%, 40px 40px, 40px 40px;
    }
    .font-tech {
      font-family: 'Chakra Petch', sans-serif;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(5px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-fadeIn {
      animation: fadeIn 0.3s ease-out forwards;
    }

    .btn-cyber {
      position: relative;
      overflow: hidden;
      transition: all 0.2s;
      border: 1px solid rgba(148, 163, 184, 0.2);
    }
    .btn-cyber:active {
      transform: scale(0.97);
    }
    
    /* é‡å­ãƒ“ãƒƒãƒˆè¡¨ç¾ - ã‚¹ãƒãƒ›æœ€é©åŒ– */
    .qubit-core {
      width: 60px; height: 60px;
      border-radius: 50%;
      position: relative;
      background: radial-gradient(circle at 30% 30%, rgba(6, 182, 212, 0.1), #020617);
      box-shadow: 0 0 15px rgba(6, 182, 212, 0.1), inset 0 0 8px rgba(6, 182, 212, 0.1);
      border: 1px solid rgba(6, 182, 212, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .qubit-orbit {
      position: absolute;
      width: 100%; height: 100%;
      border-radius: 50%;
      border: 1px dashed rgba(148, 163, 184, 0.2);
      animation: spin 10s linear infinite;
    }
    @keyframes spin { 100% { transform: rotate(360deg); } }

    .probability-node {
      width: 8px; height: 8px;
      background: #22d3ee;
      border-radius: 50%;
      box-shadow: 0 0 6px #22d3ee;
      transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
      z-index: 20;
    }

    /* Verify Badge Animation */
    @keyframes pulse-green {
      0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
      70% { box-shadow: 0 0 0 6px rgba(16, 185, 129, 0); }
      100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
    }
    .verify-success {
      animation: pulse-green 2s infinite;
    }
    
    /* Details tag styles */
    details > summary {
      list-style: none;
    }
    details > summary::-webkit-details-marker {
      display: none;
    }
    
    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-track { background: #0f172a; }
    ::-webkit-scrollbar-thumb { background: #334155; border-radius: 2px; }
  </style>
</head>
<body class="antialiased text-slate-300 text-sm">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useMemo, useEffect, useRef } = React;

    // --- è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ ---
    function clamp01(x) { if (x < 0) return 0; if (x > 1) return 1; return x; }
    
    function simpleHash(str) {
      let h = 0;
      for (let i = 0; i < str.length; i++) {
        h = (h * 131 + str.charCodeAt(i)) >>> 0;
      }
      return ("00000000" + h.toString(16)).slice(-8);
    }

    function normalize1q(s) { const n = Math.sqrt(s.a*s.a + s.b*s.b)||1; return { a:s.a/n, b:s.b/n }; }
    function normalize2q(s) { const n = Math.sqrt(s.a00*s.a00+s.a01*s.a01+s.a10*s.a10+s.a11*s.a11)||1; return {a00:s.a00/n,a01:s.a01/n,a10:s.a10/n,a11:s.a11/n}; }
    function noise1q(s) { return normalize1q({ a:s.a+(Math.random()-0.5)*0.8, b:s.b+(Math.random()-0.5)*0.8 }); }
    function noise2q(s) { const r=()=>(Math.random()-0.5)*0.6; return normalize2q({a00:s.a00+r(), a01:s.a01+r(), a10:s.a10+r(), a11:s.a11+r()}); }
    
    function measure1q(state) {
      const p0 = clamp01(state.a * state.a);
      const r = Math.random() < p0 ? 0 : 1;
      return { outcome: r };
    }
    function measure2q(state, idx) {
      const {a00,a01,a10,a11} = state;
      const p0 = idx===1 ? (a00*a00 + a01*a01) : (a00*a00 + a10*a10);
      const r = Math.random() < (p0||0) ? 0 : 1;
      return { outcome: r };
    }

    function computeMetrics(mode, s, g, n) {
      if (mode === "1q") {
        const p0 = clamp01(s.a*s.a), p1 = clamp01(s.b*s.b);
        const stability = Math.abs(p0 - p1); 
        const risk = clamp01(n / 10); 
        return { p0, p1, stability, risk };
      } else {
        const p0_1 = clamp01(s.a00*s.a00 + s.a01*s.a01), p1_1 = 1-p0_1;
        const p0_2 = clamp01(s.a00*s.a00 + s.a10*s.a10), p1_2 = 1-p0_2;
        const stability = Math.max(Math.abs(p0_1-p1_1), Math.abs(p0_2-p1_2));
        const ent = clamp01(4 * Math.abs(s.a00*s.a11 - s.a01*s.a10));
        const risk = clamp01((ent + n/10)/1.5);
        return { p0: p0_1, p1: p1_1, p0_2, p1_2, stability, risk, ent };
      }
    }

    // --- Level 3 Logic ---
    function createRuleFromKey(keyBits) {
      const patterns = [
        { f0: 0, f1: 0, kind: "constant", label: "å®šæ•° (0)" },
        { f0: 1, f1: 1, kind: "constant", label: "å®šæ•° (1)" },
        { f0: 0, f1: 1, kind: "balanced", label: "å¤‰åŒ– (åŒã˜)" },
        { f0: 1, f1: 0, kind: "balanced", label: "å¤‰åŒ– (é€†)" }
      ];

      if (!keyBits || keyBits.length < 2) {
        return patterns[Math.floor(Math.random() * patterns.length)];
      }

      const b0 = keyBits[0] === "1" ? 1 : 0;
      const b1 = keyBits[1] === "1" ? 1 : 0;
      const idx = (b0 << 1) | b1; 

      return patterns[idx];
    }

    function runQuantumScan(rule) {
      const f0 = rule.f0;
      const f1 = rule.f1;
      const H = 1 / Math.sqrt(2);
      let a00=0.0, a01=1.0, a10=0.0, a11=0.0;
      let b00=H*(a00+a10), b10=H*(a00-a10), b01=H*(a01+a11), b11=H*(a01-a11);
      let c00=H*(b00+b01), c01=H*(b00-b01), c10=H*(b10+b11), c11=H*(b10-b11);
      let d00=c00, d01=c01, d10=c10, d11=c11;
      if(f0===1){const t=d00;d00=d01;d01=t;}
      if(f1===1){const t=d10;d10=d11;d11=t;}
      let e00=H*(d00+d10), e10=H*(d00-d10), e01=H*(d01+d11), e11=H*(d01-d11);
      const p0=e00*e00+e01*e01;
      const p1=e10*e10+e11*e11;
      const kindGuess = p0 > 0.5 ? "constant" : "balanced";
      return { kindGuess, p0, p1 };
    }

    // --- UI Components ---

    function IntroModal({ onClose }) {
      return (
        <div className="fixed inset-0 z-50 bg-slate-950/95 flex items-center justify-center p-4 backdrop-blur-md animate-fadeIn">
          <div className="max-w-md w-full bg-slate-900 border border-cyan-500/30 p-5 shadow-2xl relative overflow-hidden rounded-xl">
            <h1 className="text-xl font-bold text-white mb-1 font-tech tracking-widest text-center">
              <span className="text-cyan-500">Q.W.K.</span> PROTOCOL
            </h1>
            <div className="text-[10px] font-mono text-slate-500 mb-4 border-b border-slate-800 pb-2 text-center">
              MISSION: ãƒãƒ¬ãªã„ã€Œä¸–ç•Œéµã€ã‚’ä½œã‚Œ
            </div>
            
            <div className="space-y-2 text-xs text-slate-300">
              <div className="bg-slate-800/50 p-2 rounded flex items-center gap-2">
                <i className="ph-fill ph-number-circle-one text-cyan-400 text-lg"></i>
                <div>
                  <div className="font-bold text-cyan-200 text-[11px]">éµã®é‹³é€  (Lv1-2)</div>
                  <div className="text-[10px] text-slate-400">ã€Œ0ã¨1ãŒé‡ãªã£ãŸã‚³ã‚¤ãƒ³ã€ã§éµã‚’ä½œã‚‹</div>
                </div>
              </div>

              <div className="bg-violet-950/30 p-2 rounded flex items-center gap-2">
                <i className="ph-fill ph-number-circle-three text-violet-400 text-lg"></i>
                <div>
                  <div className="font-bold text-violet-200 text-[11px]">å“è³ªæ¤œå“ (Lv3)</div>
                  <div className="text-[10px] text-slate-400">æ™®é€šã¯2å›ã‹ã‹ã‚‹æ¤œæŸ»ã‚’<span className="text-white">1å›</span>ã§æ¸ˆã¾ã™</div>
                </div>
              </div>

              <div className="bg-emerald-950/30 p-2 rounded flex items-center gap-2">
                <i className="ph-fill ph-number-circle-four text-emerald-400 text-lg"></i>
                <div>
                  <div className="font-bold text-emerald-200 text-[11px]">å‡ºè·è¨¼æ˜ (Lv4)</div>
                  <div className="text-[10px] text-slate-400"><span className="text-white">æ”¹ã–ã‚“ä¸èƒ½ãªå°å¸³</span>ã§æ­£ã—ã•ã‚’è¨¼æ˜</div>
                </div>
              </div>
            </div>
            
            <button 
              onClick={onClose}
              className="mt-5 w-full btn-cyber py-3 bg-cyan-600/20 text-cyan-400 font-bold tracking-widest hover:bg-cyan-600/40 border-cyan-500/30 text-xs"
            >
              >> SYSTEM START
            </button>
          </div>
        </div>
      );
    }

    function OsModeToggle({ osMode, setOsMode }) {
      const handleToggle = () => setOsMode((prev) => !prev);

      return (
        <div className="mt-3 mb-2 flex items-center justify-between gap-2 p-2 bg-slate-900/50 rounded border border-slate-800">
          <div className="text-[9px] text-slate-400 leading-snug">
            <div className="font-mono text-slate-300 mb-0.5 flex items-center gap-1">
              <i className="ph-fill ph-robot"></i> OSãƒ¢ãƒ¼ãƒ‰ (AIç›£è¦–)
            </div>
            <div>
              {osMode ? (
                <span>ON: <span className="text-emerald-400">ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–</span>ã€‚<br/>æ€ªã—ã„æ¸¬å®šã‚’å³ãƒ–ãƒ­ãƒƒã‚¯ã€‚</span>
              ) : (
                <span>OFF: ç›£è¦–ãªã—ã€‚<span className="text-slate-200">è‡ªç”±å®Ÿé¨“ãƒ¢ãƒ¼ãƒ‰</span>ã€‚</span>
              )}
            </div>
          </div>

          <button
            onClick={handleToggle}
            className={`shrink-0 px-2 py-1 rounded-full text-[9px] font-mono border transition-all ${
              osMode
                ? "bg-emerald-600/80 border-emerald-400 text-white shadow-[0_0_10px_rgba(16,185,129,0.3)]"
                : "bg-slate-800 border-slate-600 text-slate-500"
            }`}
          >
            {osMode ? "ç›£è¦– ON" : "ç›£è¦– OFF"}
          </button>
        </div>
      );
    }

    function QubitVisual({ p0, p1, label }) {
      const z = clamp01(p0) - clamp01(p1); 
      const topPos = 50 - (z * 40); 
      return (
        <div className="flex flex-col items-center gap-1">
           <div className="qubit-core">
             <div className="qubit-orbit"></div>
             <div className="absolute top-2 text-[8px] font-bold text-cyan-500/60">0</div>
             <div className="absolute bottom-2 text-[8px] font-bold text-purple-500/60">1</div>
             <div className="probability-node absolute left-1/2 -translate-x-1/2" style={{ top: `${topPos}%`, boxShadow: `0 0 ${10 + Math.abs(z)*10}px ${z > 0 ? '#22d3ee' : '#c084fc'}` }}></div>
           </div>
           <div className="font-tech text-[10px] text-white tracking-wider">{label}</div>
        </div>
      );
    }

    function ProbabilityBar({ p0, p1 }) {
      return (
        <div className="w-full max-w-[200px] mt-2 bg-slate-900/80 p-1.5 rounded border border-slate-700">
           <div className="flex justify-between text-[9px] font-bold text-slate-400 mb-1">
             <span className={p0 > p1 ? "text-cyan-400" : ""}>0: {Math.round(p0*100)}%</span>
             <span className={p1 > p0 ? "text-purple-400" : ""}>1: {Math.round(p1*100)}%</span>
           </div>
           <div className="h-1 w-full bg-slate-800 rounded-full overflow-hidden flex">
             <div className="h-full bg-cyan-500 transition-all duration-300" style={{ width: `${p0*100}%` }}></div>
             <div className="h-full bg-purple-500 transition-all duration-300" style={{ width: `${p1*100}%` }}></div>
           </div>
        </div>
      );
    }

    // â˜… LEVEL 3: é‡å­ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ä½“é¨“ãƒ‘ãƒãƒ«
    function Level3Panel({ onClear, keyBits, addLog }) {
      const [rule, setRule] = useState(() => createRuleFromKey(keyBits));
      const [classicResult, setClassicResult] = useState(null);
      const [classicStep, setClassicStep] = useState(0);
      const [quantumResult, setQuantumResult] = useState(null);
      const [showAnswer, setShowAnswer] = useState(false);
      const [isProcessing, setIsProcessing] = useState(false);

      useEffect(() => {
        setRule(createRuleFromKey(keyBits));
        setClassicResult(null);
        setClassicStep(0);
        setQuantumResult(null);
        setShowAnswer(false);
        setIsProcessing(false);
      }, [keyBits]);

      const resetRule = () => {
        setRule(createRuleFromKey(keyBits));
        setClassicResult(null);
        setClassicStep(0);
        setQuantumResult(null);
        setShowAnswer(false);
        setIsProcessing(false);
      };

      // Classic logic
      const runClassicStep1 = () => {
        if (isProcessing || classicStep !== 0) return;
        setIsProcessing(true);
        setTimeout(() => {
          const out0 = rule.f0; 
          setClassicResult({ out0, out1: null, kind: null });
          setClassicStep(1);
          setIsProcessing(false);
        }, 500);
      };

      const runClassicStep2 = () => {
        if (isProcessing || classicStep !== 1) return;
        setIsProcessing(true);
        setTimeout(() => {
          const out0 = classicResult?.out0 ?? rule.f0;
          const out1 = rule.f1; 
          const kind = out0 === out1 ? "constant" : "balanced";
          setClassicResult({ out0, out1, kind });
          setClassicStep(2);
          setShowAnswer(true);
          setIsProcessing(false);
        }, 500);
      };

      // Quantum logic
      const runQuantum = () => {
        if (isProcessing) return;
        setIsProcessing(true);
        setQuantumResult(null);
        setTimeout(() => {
          const res = runQuantumScan(rule);
          setQuantumResult(res);
          setShowAnswer(true);
          if (typeof addLog === 'function') addLog(3, "SCAN", res.kindGuess);
          if (typeof onClear === "function") onClear();
          setIsProcessing(false);
        }, 400);
      };

      return (
        <div className="mt-6 relative">
          <div className="absolute -inset-0.5 bg-gradient-to-r from-violet-600 to-indigo-600 rounded-xl opacity-30 blur"></div>
          <div className="relative bg-slate-900/95 border border-indigo-500/50 rounded-xl p-3 overflow-hidden">
            {/* Header */}
            <div className="flex justify-between items-start gap-1 mb-2 border-b border-indigo-500/30 pb-2">
              <div className="flex-1">
                <div className="text-[9px] text-indigo-300 font-bold mb-0.5 flex items-center gap-1">
                  <span className="w-1.5 h-1.5 bg-violet-500 rounded-full animate-pulse"></span>
                  LEVEL 3: é‡å­æ¤œå“
                </div>
                <h2 className="text-sm font-bold text-white font-tech leading-tight">
                  éµã§æ±ºã¾ã£ãŸã€Œç®±ã€ã®ãƒ«ãƒ¼ãƒ«ã‚’è¦‹æŠœã‘
                </h2>
                
                {/* ç›®çš„ã‚¬ã‚¤ãƒ‰ */}
                <div className="text-[9px] text-slate-400 mt-1 leading-snug">
                  <span className="font-semibold text-slate-100">
                    ã“ã“ã§ã¯ã€å›ç·šãŒ f(0)=f(1) å‹ã‹ f(0)â‰ f(1) å‹ã‹ã‚’ã§ãã‚‹ã ã‘å°‘ãªã„è³ªå•å›æ•°ã§è¦‹åˆ†ã‘ã¾ã™ã€‚
                  </span><br/>
                  <span className="text-slate-200">A. f(0)=f(1)</span> [åŒã˜] ã‹ã€
                  <span className="text-slate-200"> B. f(0)â‰ f(1)</span> [é•ã†] ã‹ã€‚
                </div>
              </div>
              <div className="text-right shrink-0">
                <div className="text-[8px] text-slate-500 mb-0.5">æ­£è§£</div>
                <div className="text-[9px] font-bold text-indigo-300 mb-1 h-auto flex flex-col items-end justify-center text-right leading-tight max-w-[80px]">
                  {showAnswer ? (
                    rule.kind === "constant" ? 
                    <>f(0)=f(1)<br/><span className="text-[8px] font-normal">åŒã˜</span></> : 
                    <>f(0)â‰ f(1)<br/><span className="text-[8px] font-normal">é•ã†</span></>
                  ) : "???"}
                </div>
                <button
                  onClick={resetRule}
                  disabled={isProcessing}
                  className="mt-1 px-2 py-1 rounded bg-slate-800 text-[9px] text-slate-400 border border-slate-700 disabled:opacity-50"
                >
                  <i className="ph-bold ph-arrows-clockwise"></i> ç®±ã‚’å¤‰ãˆã‚‹
                </button>
              </div>
            </div>

            {/* PC Comparison */}
            <div className="grid grid-cols-2 gap-2">
              {/* Classic */}
              <div className="bg-slate-950/60 border border-slate-800 rounded p-2 flex flex-col">
                <div className="flex justify-between items-center mb-1">
                  <span className="text-[9px] font-bold text-slate-400">æ™®é€šã®PC</span>
                  <span className="text-[8px] bg-slate-800 text-slate-500 px-1 rounded">2å›å¿…è¦</span>
                </div>
                <div className="flex-1 bg-black/40 rounded p-1 mb-1 font-mono text-[9px] text-slate-300 h-14 overflow-hidden leading-snug">
                  {classicStep === 0 && <div className="h-full flex items-center justify-center opacity-50 text-[8px]">ãƒœã‚¿ãƒ³ã§è³ªå•â†“</div>}
                  {classicStep >= 1 && classicResult && (
                    <div className="animate-fadeIn">
                      <div>Q:0 â†’ {classicResult.out0}</div>
                      <div>Q:1 â†’ {classicStep === 2 ? classicResult.out1 : "..."}</div>
                      {classicStep === 2 && (
                        <div className="text-emerald-400 mt-0.5 text-[8px] border-t border-slate-700 pt-1">
                          {classicResult.kind === "constant"
                            ? "åˆ¤å®š: f(0)=f(1) (åŒã˜)"
                            : "åˆ¤å®š: f(0)â‰ f(1) (é•ã†)"}
                        </div>
                      )}
                    </div>
                  )}
                </div>
                <div className="flex gap-1">
                  <button onClick={runClassicStep1} disabled={isProcessing || classicStep !== 0} className="flex-1 py-1.5 rounded bg-slate-800 text-[9px] border border-slate-600 disabled:opacity-40">1.ã€Œ0ã€?</button>
                  <button onClick={runClassicStep2} disabled={isProcessing || classicStep !== 1} className="flex-1 py-1.5 rounded bg-slate-800 text-[9px] border border-slate-600 disabled:opacity-40">2.ã€Œ1ã€?</button>
                </div>
              </div>

              {/* Quantum */}
              <div className="bg-indigo-950/20 border border-indigo-500/30 rounded p-2 flex flex-col relative overflow-hidden">
                <div className="absolute top-0 left-0 w-full h-0.5 bg-indigo-500 shadow-[0_0_5px_#6366f1]"></div>
                <div className="flex justify-between items-center mb-1">
                  <span className="text-[9px] font-bold text-indigo-200">é‡å­PC</span>
                  <span className="text-[8px] bg-indigo-900/60 text-indigo-200 px-1 rounded font-bold">1å›ã§OK</span>
                </div>
                <div className="flex-1 bg-black/40 rounded p-1 mb-1 font-mono text-[9px] text-indigo-200 h-14 overflow-hidden leading-snug">
                  {quantumResult ? (
                    <div className="animate-fadeIn">
                      <div className="text-indigo-300">âœ” å®Œäº†</div>
                      <div className="text-[8px] text-slate-500">0ã¨1ã‚’åŒæ™‚å…¥åŠ›</div>
                      <div className="text-cyan-300 font-bold mt-0.5 text-[8px] pt-1 border-t border-indigo-900/50">
                        åˆ¤å®š: {quantumResult.kindGuess === "constant"
                          ? "f(0)=f(1) (åŒã˜)"
                          : "f(0)â‰ f(1) (é•ã†)"}
                      </div>
                    </div>
                  ) : (
                    <div className="h-full flex items-center justify-center opacity-50 text-[8px] text-center">é‡ã­åˆã‚ã›ã§<br/>ä¸€ç™ºãƒã‚§ãƒƒã‚¯</div>
                  )}
                </div>
                <button onClick={runQuantum} disabled={isProcessing} className="w-full py-1.5 rounded bg-indigo-600 text-white text-[9px] font-bold shadow-lg disabled:opacity-40">
                  âš¡ ä¸€ç™ºã‚¹ã‚­ãƒ£ãƒ³
                </button>
              </div>
            </div>

            {/* Explanation */}
            <div className="mt-2 p-2 rounded-lg bg-black/50 border border-cyan-500/40">
              <div className="text-[9px] font-mono text-cyan-300 mb-0.5">ğŸ’¡ é‡å­ã®é­”æ³•</div>
              <p className="text-[9px] text-slate-300 leading-tight">
                ã€Œ2å›ãŒ1å›ã«ãªã£ãŸã ã‘ã€ã«è¦‹ãˆã¾ã™ãŒã€ã‚‚ã—ã“ã‚ŒãŒ1å„„æ¡ãªã‚‰ï¼Ÿ<br/>
                æ™®é€šã¯1å„„å›ã‹ã‹ã‚‹ã¨ã“ã‚ã‚’ã€é‡å­ãªã‚‰<span className="font-semibold text-white">ãŸã£ãŸ1å›</span>ã§æ­£è§£ã‚’è¦‹æŠœãã¾ã™ã€‚<br/>
                <span className="font-semibold text-slate-100">
                  ã“ã®ãƒ¬ãƒ™ãƒ«ã¯ã€ã€Œãªãœé‡å­ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãŒâ€œå›ç·šãƒã‚§ãƒƒã‚¯â€ã«å‘ã„ã¦ã„ã‚‹ã‹ã€ã®ãƒŸãƒ‹ç‰ˆä½“é¨“ã§ã™ã€‚
                </span>
              </p>
            </div>
          </div>
        </div>
      );
    }

    // â˜… LEVEL 4: Quantum OS Ledger & Verify
    function Level4Panel({ keyBits, ledger, onTamper, onSyncFromLedger }) {
      const [result, setResult] = useState(null);
      const scrollRef = useRef(null);
      
      useEffect(() => {
        if (scrollRef.current) scrollRef.current.scrollTop = scrollRef.current.scrollHeight;
      }, [ledger]);

      const latestRows = ledger.slice(-5).reverse();

      const runVerify = () => {
        if (!ledger.length) { setResult({ ok: false, reason: "ãƒ‡ãƒ¼ã‚¿ãªã—" }); return; }
        
        let prevHash = "QOS-ROOT";
        for (let i = 0; i < ledger.length; i++) {
          const e = ledger[i];
          const raw = JSON.stringify({ idx: i, prevHash, step: e.step, level: e.level, op: e.op, payload: e.payload });
          const expectHash = simpleHash(raw);
          if (e.prevHash !== prevHash || e.hash !== expectHash) {
            setResult({ ok: false, reason: `L${i}ã§æ”¹ã–ã‚“æ¤œçŸ¥` }); return;
          }
          prevHash = e.hash;
        }

        const fromLedger = ledger.filter(e => e.step === "KEY_BIT")
          .sort((a, b) => a.payload.bitIndex - b.payload.bitIndex)
          .map(e => e.payload.bit).join("");

        if (!fromLedger) { setResult({ ok: false, reason: "éµãƒ‡ãƒ¼ã‚¿ãªã—" }); return; }
        
        // â˜… ç”»é¢ãŒã‚ºãƒ¬ã¦ã„ãŸã‚‰ã€OSã®æ¨©é™ã§å¼·åˆ¶åŒæœŸï¼ˆä¸Šæ›¸ãï¼‰ã™ã‚‹
        const repaired = fromLedger !== keyBits;
        if (repaired && typeof onSyncFromLedger === "function") {
          onSyncFromLedger(fromLedger);
        }

        setResult({ ok: true, bitsFromLedger: fromLedger, repaired });
      };

      return (
        <div className="mt-4 bg-slate-950/80 border border-cyan-700/60 rounded-xl p-3">
          <div className="flex justify-between items-center mb-2">
            <div>
              <div className="text-[9px] text-cyan-300 font-mono mb-0.5">
                LEVEL 4: QUANTUM OS LEDGER
              </div>
              <div className="text-[9px] text-slate-300 leading-snug">
                çœŸå®Ÿã¯å°å¸³ã®ã¿ã€‚ãƒ­ã‚°ã‹ã‚‰è¨¼æ˜ã›ã‚ˆã€‚
              </div>
            </div>
            <button onClick={runVerify} className="px-3 py-2 rounded bg-cyan-600 text-[10px] font-bold text-white shadow hover:bg-cyan-500">
              è¨¼æ˜ (Verify)
            </button>
          </div>

          <div className="grid grid-cols-5 gap-2 mb-2">
            {/* Left: Ledger View */}
            <div className="col-span-3 bg-black/40 rounded p-2 border border-slate-800">
              <div className="flex justify-between items-end border-b border-slate-800 pb-1 mb-1">
                <span className="text-[9px] text-slate-500">LIVE LEDGER</span>
                <span className="text-[8px] text-slate-600 font-mono">{ledger.length} RECS</span>
              </div>
              {latestRows.length === 0 ? (
                <div className="text-[9px] text-slate-600 py-2 text-center">è¨˜éŒ²ä¸­...</div>
              ) : (
                <div className="space-y-1 max-h-20 overflow-auto" ref={scrollRef}>
                  {latestRows.map((e) => (
                    <div key={e.id} className="flex items-center justify-between text-[8px] font-mono bg-slate-900/70 px-1 py-0.5 rounded animate-fadeIn">
                      <div className="flex gap-1 overflow-hidden">
                        <span className="text-slate-500">L{e.id}</span>
                        <span className="text-cyan-300/70">Lv{e.level}</span>
                        <span className="truncate text-slate-300">
                          {e.step === "KEY_BIT" ? `BIT=${e.payload.bit}` : e.op}
                        </span>
                      </div>
                      <div className="text-[7px] text-slate-600 pl-1">{e.hash.slice(0, 4)}</div>
                    </div>
                  ))}
                </div>
              )}
            </div>

            {/* Right: Verify Result */}
            <div className="col-span-2 bg-slate-900/80 rounded p-2 border border-slate-800 flex flex-col justify-between">
              <div>
                <div className="text-[9px] text-slate-500 mb-1">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</div>
                {result ? (
                  result.ok ? (
                    <div className="animate-fadeIn space-y-1">
                      <div className="flex items-center gap-1 text-[10px] text-emerald-400 font-bold">
                        <span className="w-1.5 h-1.5 rounded-full bg-emerald-400 animate-pulse"></span>
                        ADIC-STYLE: OK
                      </div>
                      <div className="text-[9px] text-slate-200 leading-tight">
                        å°å¸³ã‹ã‚‰å†æ§‹æˆ:<br/>
                        <span className="font-mono text-cyan-300 break-all text-[8px]">{result.bitsFromLedger}</span>
                      </div>
                      {result.repaired ? (
                        <div className="text-[8px] text-amber-300 leading-tight mt-0.5">
                          ç”»é¢ã¨ã‚ºãƒ¬ã¦ã„ãŸãŸã‚ã€OSãŒ<span className="font-bold">å°å¸³ã®å€¤ã§å¼·åˆ¶ä¸Šæ›¸ã</span>ã—ã¾ã—ãŸã€‚
                        </div>
                      ) : (
                        <div className="text-[8px] text-slate-400 leading-tight mt-0.5">
                          ç”»é¢ã¯ä½¿ã‚ãšã€<span className="font-semibold text-emerald-400/70">å°å¸³ã ã‘ã§å®Œå…¨å¾©å…ƒ</span>ã—ã¾ã—ãŸã€‚
                        </div>
                      )}
                    </div>
                  ) : (
                    <div className="animate-fadeIn">
                      <div className="flex items-center gap-1 text-[10px] text-rose-400 font-bold">
                        <span className="w-1.5 h-1.5 rounded-full bg-rose-400 animate-pulse"></span>
                        æ”¹ã–ã‚“æ¤œçŸ¥
                      </div>
                      <div className="text-[8px] text-rose-200 leading-tight mt-0.5">{result.reason}</div>
                    </div>
                  )
                ) : (
                  <div className="text-[8px] text-slate-500">æœªæ¤œè¨¼</div>
                )}
              </div>
              <button onClick={onTamper} className="mt-2 w-full px-1 py-1 rounded border border-rose-500/60 text-[8px] text-rose-300 bg-rose-950/30">
                âš  ãƒ­ã‚°ã‚’å£Šã™
              </button>
            </div>
          </div>
        </div>
      );
    }

    function OSLog({ lastDecision }) {
      if (!lastDecision) return <div className="h-8 bg-slate-900/50 border-t border-slate-800 p-2 flex items-center justify-center text-slate-600 text-[9px]">[ AIç›£è¦–ä¸­ ]</div>;
      const isBlocked = lastDecision.decision === "ãƒ–ãƒ­ãƒƒã‚¯";
      return (
        <div className={`h-8 border-t px-3 flex items-center gap-2 ${isBlocked ? "bg-red-950/20 border-red-900/50" : "bg-emerald-950/10 border-slate-800"}`}>
          <div className={isBlocked ? "text-red-500" : "text-emerald-400"}><i className={isBlocked ? "ph-fill ph-warning-octagon" : "ph-fill ph-check-circle"}></i></div>
          <div className={`text-[9px] leading-tight truncate ${isBlocked ? "text-red-200" : "text-slate-300"}`}>{lastDecision.msg}</div>
        </div>
      );
    }

    // --- ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒª ---
    function QuantumApp() {
      const TARGET_LENGTH = 12; 
      const [showIntro, setShowIntro] = useState(true);
      const [mode, setMode] = useState("1q");
      const [osMode, setOsMode] = useState(true);
      const [s1, setS1] = useState({a:1, b:0}); 
      const [s2, setS2] = useState({a00:1, a01:0, a10:0, a11:0}); 
      const [history, setHistory] = useState([]); 
      const [keyBits, setKeyBits] = useState("");
      const [isFinished, setIsFinished] = useState(false);
      const [lastDecision, setLastDecision] = useState(null);
      const [level3Cleared, setLevel3Cleared] = useState(false);
      const [ledger, setLedger] = useState([]);

      const appendLedger = (entry) => {
        setLedger((prev) => {
          const idx = prev.length;
          const prevHash = idx === 0 ? "QOS-ROOT" : prev[idx - 1].hash;
          const raw = JSON.stringify({ idx, prevHash, step: entry.step, level: entry.level, op: entry.op, payload: entry.payload });
          const hash = simpleHash(raw);
          return [...prev, { id: idx, step: entry.step, level: entry.level, op: entry.op, payload: entry.payload, prevHash, hash }];
        });
      };

      const tamperLastBitInLedger = () => {
        setLedger((prev) => {
          const copy = [...prev];
          for (let i = copy.length - 1; i >= 0; i--) {
            if (copy[i].step === "KEY_BIT") {
              const oldBit = copy[i].payload.bit;
              copy[i] = { ...copy[i], payload: { ...copy[i].payload, bit: oldBit === "0" ? "1" : "0" } };
              break;
            }
          }
          return copy;
        });
      };

      const metrics = useMemo(() => mode === "1q" ? computeMetrics("1q", s1, 0, 0) : computeMetrics("2q", s2, 0, 0), [mode, s1, s2]);

      const reset = (newMode = 1) => {
        if(newMode === 1) setS1({a:1, b:0}); else setS2({a00:1, a01:0, a10:0, a11:0});
        setLastDecision(null); setKeyBits(""); setIsFinished(false); setHistory([]); setLevel3Cleared(false);
        setLedger([]); 
      };

      const copyToClipboard = (text) => {
        const t = document.createElement("textarea"); t.value = text; document.body.appendChild(t); t.select();
        try { document.execCommand('copy'); } catch (e) {} document.body.removeChild(t);
      };

      // â˜… Auto Prepare
      const handleAutoPrepare = () => {
        if (mode === "1q") {
          // Hadamard
          setS1({ a: 0.7071, b: 0.7071 });
          setLastDecision({ decision: "è¨±å¯", msg: "é‡å­ã‚³ã‚¤ãƒ³ã‚’50:50ã§æº–å‚™ã—ã¾ã—ãŸ", id: Date.now() });
          appendLedger({ step: "OP", level: 1, op: "æº–å‚™(è‡ªå‹•)", payload: { desc: "50:50" } });
        } else {
          // Entangle (Bell State)
          setS2({ a00: 0.707, a01: 0, a10: 0, a11: 0.707 });
          setLastDecision({ decision: "è¨±å¯", msg: "ãƒšã‚¢ã®é‡å­ã‚³ã‚¤ãƒ³ã‚’ãƒªãƒ³ã‚¯ã•ã›ã¾ã—ãŸ", id: Date.now() });
          appendLedger({ step: "OP", level: 2, op: "æº–å‚™(è‡ªå‹•)", payload: { desc: "ãƒªãƒ³ã‚¯å®Œäº†" } });
        }
      };

      // Advanced Ops
      const handleBias = () => {
        if (osMode && metrics.stability > 0.8) { setLastDecision({ decision: "ãƒ–ãƒ­ãƒƒã‚¯", msg: "åã‚Šã™ãï¼è­¦å‘Š", id: Date.now() }); setHistory(p => [...p, "åã‚Š"]); return; }
        if(mode === "1q") setS1({ a: 0.95, b: 0.31 }); else setS2({ a00:0.9, a01:0.1, a10:0.1, a11:0.4 });
        setLastDecision({ decision: "è¨±å¯", msg: "0ã‚’å‡ºã‚„ã™ãã—ã¾ã—ãŸ", id: Date.now() });
        appendLedger({ step: "OP", level: mode === "1q" ? 1 : 2, op: "åã‚‰ã›ã‚‹", payload: { desc: "0æœ‰åˆ©" } });
      };

      const handleHadamard = () => {
        if(mode === "1q") setS1({ a: 0.7071, b: 0.7071 }); else setS2({ a00:0.5, a01:0.5, a10:0.5, a11:0.5 }); 
        setLastDecision({ decision: "è¨±å¯", msg: "ç¢ºç‡ã‚’50:50ã«ã—ã¾ã—ãŸ", id: Date.now() });
        appendLedger({ step: "OP", level: mode === "1q" ? 1 : 2, op: "æ··ãœã‚‹", payload: { desc: "50:50" } });
      };

      const handleEntangle = () => {
        if (mode === "1q") return;
        setS2({a00:0.707, a01:0, a10:0, a11:0.707}); 
        setLastDecision({ decision: "è¨±å¯", msg: "é‹å‘½ã‚’ãƒªãƒ³ã‚¯ã•ã›ã¾ã—ãŸ", id: Date.now() });
        appendLedger({ step: "OP", level: 2, op: "ãƒªãƒ³ã‚¯", payload: { desc: "é‡å­ã‚‚ã¤ã‚Œ" } });
      };

      const handleNoise = () => {
        if(mode==="1q") setS1(noise1q(s1)); else setS2(noise2q(s2));
        setLastDecision({ decision: "è¨±å¯", msg: "æºã‚‰ã—ã¾ã—ãŸ", id: Date.now() });
        appendLedger({ step: "OP", level: mode === "1q" ? 1 : 2, op: "æºã‚‰ã™", payload: { desc: "ãƒã‚¤ã‚º" } });
      };

      const handleMeasure = () => {
        if (osMode && metrics.stability > 0.92) { setLastDecision({ decision: "ãƒ–ãƒ­ãƒƒã‚¯", msg: "ãƒãƒ¬ãƒãƒ¬ã§ã™ï¼", id: Date.now() }); setHistory(p => [...p, "äºˆæ¸¬å¯èƒ½"]); return; }
        let bit = "";
        if(mode==="1q") { const r = measure1q(s1); bit = r.outcome.toString(); } 
        else { const r = measure2q(s2, 1); bit = r.outcome.toString(); }
        
        const index = keyBits.length;
        const newKey = keyBits + bit;
        appendLedger({ step: "KEY_BIT", level: mode === "1q" ? 1 : 2, op: mode === "1q" ? "æ¸¬å®š(Lv1)" : "æ¸¬å®š(Lv2)", payload: { bitIndex: index, bit } });

        setKeyBits(newKey);
        setLastDecision({ decision: "è¨±å¯", msg: `ã€Œ${bit}ã€ã§ç¢ºå®š`, id: Date.now() });
        if (newKey.length >= TARGET_LENGTH) setIsFinished(true);
      };

      return (
        <div className="min-h-screen flex justify-center bg-[#020617] pb-24">
          {showIntro && <IntroModal onClose={() => setShowIntro(false)} />}
          
          <div className="w-full max-w-md p-3 flex flex-col">
            {/* Header */}
            <div className="flex justify-between items-end border-b border-slate-800 pb-2 mb-2">
              <div>
                <h1 className="text-lg font-bold text-white tracking-widest font-tech flex gap-2 items-center"><i className="ph-fill ph-fingerprint text-cyan-500"></i> KEY FACTORY</h1>
                <p className="text-[8px] text-cyan-700 font-bold tracking-widest">MISSION: 12ãƒ“ãƒƒãƒˆã®ä¸–ç•Œéµã‚’ä½œã‚‹</p>
              </div>
              <div className="text-right">
                <div className="text-[8px] text-slate-500">æš—å·éµã®é€²è¡ŒçŠ¶æ³</div>
                <div className="text-base font-bold text-cyan-400 font-mono leading-none">
                  {keyBits.length}<span className="text-[10px] text-slate-600"> / {TARGET_LENGTH} ãƒ“ãƒƒãƒˆ</span>
                </div>
                <div className="text-[8px] text-slate-500 mt-0.5">â€»12ãƒ“ãƒƒãƒˆã§ã‚´ãƒ¼ãƒ«</div>
              </div>
            </div>
            
            {/* Goal Card */}
            <div className="mb-3 text-[10px] text-slate-300 space-y-1.5">
              <div className="font-mono text-slate-400">ã“ã®ãƒšãƒ¼ã‚¸ã®ã‚´ãƒ¼ãƒ«</div>
              <div className="bg-slate-900/60 border border-slate-800 rounded p-2 space-y-1">
                <div className="flex items-start gap-2">
                  <span className="text-cyan-400 text-xs"><i className="ph-bold ph-number-circle-one"></i></span>
                  <div>
                    <div className="font-semibold text-slate-100">Lv1ãƒ»2: ãƒ©ãƒ³ãƒ€ãƒ ãª12ãƒ“ãƒƒãƒˆã‚’ä½œã‚‹</div>
                    <div className="text-[9px] text-slate-400">ã‚³ã‚¤ãƒ³ã‚’å›ã—ã¦ã€Œ0/1ã€ã‚’12å›æ±ºã‚ã¾ã™ã€‚</div>
                  </div>
                </div>
                <div className="flex items-start gap-2">
                  <span className="text-violet-400 text-xs"><i className="ph-bold ph-number-circle-two"></i></span>
                  <div>
                    <div className="font-semibold text-slate-100">Lv3: å›ç·šãƒ†ã‚¹ãƒˆ</div>
                    <div className="text-[9px] text-slate-400">2å›ã‹ã‹ã‚‹è³ªå•ã‚’ã€é‡å­ãªã‚‰1å›ã§è¦‹æŠœã‘ã‚‹ä½“é¨“ã€‚</div>
                  </div>
                </div>
                <div className="flex items-start gap-2">
                  <span className="text-amber-400 text-xs"><i className="ph-bold ph-number-circle-three"></i></span>
                  <div>
                    <div className="font-semibold text-slate-100">Lv4: OSç›£æŸ»</div>
                    <div className="text-[9px] text-slate-400">ç”»é¢ãŒæ¶ˆãˆã¦ã‚‚ã€å°å¸³ã‹ã‚‰éµã‚’å¾©å…ƒã§ãã‚‹ã‹ç¢ºèªã€‚</div>
                  </div>
                </div>
              </div>
            </div>

            {/* Mode Tabs */}
            <div className="flex gap-1 mb-3 bg-slate-900/50 p-1 rounded border border-slate-800">
              <button onClick={() => { setMode("1q"); reset(1); }} className={`flex-1 py-1.5 rounded text-[10px] font-bold flex items-center justify-center gap-1 ${mode==="1q" ? "bg-cyan-900/30 text-cyan-300" : "text-slate-500"}`}>
                <i className="ph-bold ph-circle"></i> Lv.1 ã‚³ã‚¤ãƒ³
              </button>
              <button onClick={() => { setMode("2q"); reset(2); }} className={`flex-1 py-1.5 rounded text-[10px] font-bold flex items-center justify-center gap-1 ${mode==="2q" ? "bg-purple-900/30 text-purple-300" : "text-slate-500"}`}>
                <i className="ph-bold ph-circles-three"></i> Lv.2 ãƒšã‚¢
              </button>
            </div>

            {/* Visualizer Panel */}
            <div className="bg-slate-950/50 border border-slate-800 rounded-xl p-3 mb-3 flex flex-col items-center relative overflow-hidden min-h-[140px] justify-center">
               {/* Guide Text inside Panel */}
               <div className="absolute top-2 left-3 right-3 text-[9px] text-slate-400 text-center z-10">
                 <span className="font-semibold text-slate-200">Lv{mode==="1q"?1:2} ã‚¬ã‚¤ãƒ‰:</span> ã€Œæº–å‚™ã€â†’ã€Œã‚¹ãƒˆãƒƒãƒ—ã€ã§1ãƒ“ãƒƒãƒˆç”Ÿæˆ
               </div>

               <div className="flex gap-6 z-10 scale-90 mt-4">
                 {mode === "1q" ? <QubitVisual p0={metrics.p0} p1={metrics.p1} label="QUBIT" /> : 
                   <><QubitVisual p0={metrics.p0} p1={metrics.p1} label="A (å…„)" /><QubitVisual p0={metrics.p0_2} p1={metrics.p1_2} label="B (å¼Ÿ)" /></>}
               </div>
               <ProbabilityBar p0={mode==="1q" ? metrics.p0 : metrics.p0} p1={mode==="1q" ? metrics.p1 : metrics.p1} />
            </div>

            {/* Controls */}
            <div className="grid grid-cols-2 gap-2 mb-2">
              {/* Left: Auto Prepare + Details */}
              <div className="col-span-1 space-y-1.5">
                <div className="text-[9px] font-bold text-cyan-500 border-b border-cyan-900/30 pb-0.5">â‘  æº–å‚™ (ã“ã‚Œã ã‘ã§OK)</div>
                <button
                  onClick={handleAutoPrepare}
                  className="w-full bg-slate-800 hover:bg-slate-700 p-1.5 text-left rounded flex items-center gap-2 border border-cyan-600/40"
                >
                  <div className="text-cyan-400 text-lg"><i className="ph-bold ph-coin"></i></div>
                  <div>
                    <div className="text-[10px] font-bold text-slate-50">{mode==="1q" ? "ã‚³ã‚¤ãƒ³ã‚’æº–å‚™" : "ãƒšã‚¢ã‚’æº–å‚™"}</div>
                    <div className="text-[8px] text-slate-400">{mode==="1q" ? "50:50ã«ã‚»ãƒƒãƒˆ" : "50:50+ãƒªãƒ³ã‚¯"}</div>
                  </div>
                </button>

                <details className="bg-slate-900/80 rounded border border-slate-800">
                  <summary className="text-[8px] px-2 py-1 cursor-pointer text-slate-500 hover:text-slate-300">â–¼ ãã‚ã—ã (å®Ÿé¨“ç”¨)</summary>
                  <div className="p-1.5 space-y-1">
                    <button onClick={handleHadamard} className="w-full bg-slate-800 p-1.5 text-left rounded flex gap-2"><div className="text-cyan-400"><i className="ph-bold ph-arrows-clockwise"></i></div><div className="text-[9px] text-white">æ··ãœã‚‹</div></button>
                    <button onClick={handleBias} className="w-full bg-slate-800 p-1.5 text-left rounded flex gap-2"><div className="text-amber-400"><i className="ph-bold ph-magnet"></i></div><div className="text-[9px] text-white">åã‚‰ã›ã‚‹ (æ‚ª)</div></button>
                    {mode==="2q" && <button onClick={handleEntangle} className="w-full bg-slate-800 p-1.5 text-left rounded flex gap-2"><div className="text-purple-400"><i className="ph-bold ph-infinity"></i></div><div className="text-[9px] text-white">ãƒªãƒ³ã‚¯</div></button>}
                    <button onClick={handleNoise} className="w-full bg-slate-800 p-1.5 text-left rounded flex gap-2"><div className="text-slate-400"><i className="ph-bold ph-hand-waving"></i></div><div className="text-[9px] text-white">æºã‚‰ã™</div></button>
                  </div>
                </details>
              </div>

              {/* Right: Stop */}
              <div className="col-span-1 space-y-1.5 flex flex-col">
                <div className="text-[9px] font-bold text-emerald-500 border-b border-emerald-900/30 pb-0.5">â‘¡ æ±ºå®š (æ•°å­—ç¢ºå®š)</div>
                <button onClick={handleMeasure} className="flex-1 btn-cyber bg-emerald-900/20 border-emerald-500/30 flex flex-col items-center justify-center p-2 rounded-xl active:bg-emerald-800/40">
                  <i className="ph-bold ph-hand-palm text-3xl text-emerald-500 mb-1"></i>
                  <span className="text-sm font-bold text-white">ã‚¹ãƒˆãƒƒãƒ—ï¼</span>
                  <span className="text-[9px] text-emerald-400">1ãƒ“ãƒƒãƒˆç¢ºå®š</span>
                </button>
              </div>
            </div>

            {/* Key Monitor & Log */}
            <div className="bg-black border border-slate-800 rounded-t p-2 mb-0">
               <div className="text-[9px] text-slate-500">GENERATED KEY</div>
               <div className="text-lg font-mono text-cyan-400 tracking-widest break-all leading-none">{keyBits || "..."}</div>
            </div>
            <OSLog lastDecision={lastDecision} />

            {/* Level 3: keyBits ã‚’æ¸¡ã™ */}
            <Level3Panel 
              keyBits={keyBits} 
              onClear={() => setLevel3Cleared(true)} 
              addLog={(level, op, value) => appendLedger({ step: "SCAN", level, op: "é‡å­åˆ¤å®š", payload: { desc: value } })} 
            />

            {/* Level 4: Ledger & Verify */}
            <Level4Panel 
              keyBits={keyBits}
              ledger={ledger}
              onTamper={tamperLastBitInLedger}
              onSyncFromLedger={(bits) => setKeyBits(bits)} 
            />

            {/* System Architecture Summary */}
            <div className="mt-4 grid grid-cols-2 gap-2 text-[9px]">
              <div className="bg-slate-950/80 border border-slate-800 rounded-lg p-2">
                <div className="font-mono text-slate-300 mb-1 flex items-center gap-1"><i className="ph-fill ph-shield-warning"></i> OSãƒ¢ãƒ¼ãƒ‰(è­¦å‚™)</div>
                <p className="text-slate-400 leading-snug">
                  Lv1ãƒ»2ã§å‹•ä½œã€‚<br/>
                  æ¸¬å®šã®ãŸã³ã«æºã‚Œã‚’ç›£è¦–ã—ã€å±ãªã„ãƒ‘ã‚¿ãƒ¼ãƒ³ãªã‚‰
                  <span className="font-semibold text-slate-200">ãã®å ´ã§ãƒ–ãƒ­ãƒƒã‚¯</span>
                  ã—ã¾ã™ã€‚
                </p>
              </div>

              <div className="bg-slate-950/80 border border-cyan-700/60 rounded-lg p-2">
                <div className="font-mono text-cyan-300 mb-1 flex items-center gap-1"><i className="ph-fill ph-book-bookmark"></i> Ledger(ä¼šè¨ˆ)</div>
                <p className="text-slate-400 leading-snug">
                  Lv4ã§å‹•ä½œã€‚<br/>
                  å…¨ã¦çµ‚ã‚ã£ãŸå¾Œã«ã€
                  <span className="font-semibold text-cyan-200">ç”»é¢ã‚’ä¸€åˆ‡è¦‹ãšã«</span>
                  å°å¸³ã ã‘ã‹ã‚‰éµã‚’å¾©å…ƒã—ã¦ç›£æŸ»ã—ã¾ã™ã€‚
                </p>
              </div>
            </div>

            <OsModeToggle osMode={osMode} setOsMode={setOsMode} />

          </div>

          {/* Result Overlay */}
          {isFinished && (
            <div className="fixed inset-0 z-50 bg-black/95 flex items-center justify-center p-6 animate-fadeIn">
               <div className="w-full max-w-sm border border-emerald-500/50 p-6 bg-slate-900 rounded-xl relative overflow-hidden">
                 <div className="absolute top-0 left-0 w-full h-1 bg-emerald-500"></div>
                 <div className="text-center mb-4">
                   <div className="text-emerald-500 text-3xl mb-1"><i className="ph-fill ph-certificate"></i></div>
                   <h2 className="text-xl font-bold text-white">MISSION COMPLETE</h2>
                 </div>
                 <div className="bg-black p-3 rounded mb-4 border border-slate-800 text-center">
                   <div className="text-[9px] text-slate-500 mb-1">FINAL KEY</div>
                   <div className="text-xl font-mono text-cyan-300 tracking-widest select-all">{keyBits}</div>
                 </div>
                 <div className={`p-3 mb-4 rounded text-xs border ${history.length === 0 ? "bg-emerald-950/30 border-emerald-500/30 text-emerald-200" : "bg-amber-950/30 border-amber-500/30 text-amber-200"}`}>
                    <div className="font-bold mb-1">{history.length === 0 ? "è©•ä¾¡: S (å®Œç’§)" : `è©•ä¾¡: B (è­¦å‘Š${history.length}å›)`}</div>
                    <p className="mt-1 text-[10px] text-slate-300">
                      ã“ã®éµã¯ã€è‡ªåˆ†ã ã‘ã®ã€Œã²ã¿ã¤ãƒ•ã‚©ãƒ«ãƒ€ã€ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¨ã—ã¦ä½¿ãˆã¾ã™ã€‚
                    </p>
                    
                    {level3Cleared && (
                      <div className="mt-2 pt-2 border-t border-white/10 text-left">
                        <div className="flex items-center gap-2 mb-1">
                          <span className="text-lg">ğŸ†</span>
                          <div>
                            <div className="text-[9px] text-violet-300 font-bold uppercase">Award</div>
                            <div className="text-[10px] font-bold text-white">é‡å­ã‚¹ã‚­ãƒ£ãƒ³ä½“é¨“æ¸ˆ</div>
                          </div>
                        </div>
                        <p className="text-[9px] text-slate-300 leading-snug">
                          <span className="font-semibold text-cyan-300">1å›ã®é‡å­ã‚¹ã‚­ãƒ£ãƒ³</span>ã¯ã€ã€Œ1å„„å›ã®ç·å½“ãŸã‚Šã€ã‚’ä¸€ç¬ã§çµ‚ã‚ã‚‰ã›ã‚‹æŠ€è¡“ã®å…¥ã‚Šå£ã§ã™ã€‚
                        </p>
                      </div>
                    )}
                 </div>
                 <div className="grid grid-cols-2 gap-3">
                    <button onClick={() => reset(1)} className="btn-cyber py-2 bg-slate-800 text-xs font-bold text-slate-300 rounded">ç ´æ£„</button>
                    <button onClick={() => copyToClipboard(keyBits)} className="btn-cyber py-2 bg-emerald-600 text-xs font-bold text-white border-emerald-500 rounded">ã‚³ãƒ”ãƒ¼ã—ã¦çµ‚äº†</button>
                 </div>
               </div>
            </div>
          )}
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<QuantumApp />);
  </script>
</body>
</html>
